<!doctype html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>MDR STORE - Katalog Produk</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom Properties and Base Styles */
        :root {
            --primary-color: #008ca7;
            --primary-dark: #006b80;
            --bs-primary-rgb: 0, 140, 167;
            --bs-primary: var(--primary-color);
            --bs-link-color-rgb: var(--bs-primary-rgb);
            --bg-primary: #f0f9ff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 100, 120, 0.1);
            --logo-url: url("https://firebasestorage.googleapis.com/v0/b/mdr-store-45ddc.firebasestorage.app/o/Logo%201%20Transparant.png?alt=media&token=64b0274b-bdee-4592-8a6b-913c4f37fd16");
            --radius-medium: 16px;
            --radius-large: 24px;
        }

        html {
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        body {
            font-family:
                "Poppins",
                "Segoe UI",
                system-ui,
                -apple-system,
                sans-serif;
            background: linear-gradient(to bottom,
                    var(--primary-color) 0%,
                    var(--primary-color) 150px,
                    var(--bg-primary) 350px);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .icon-wrapper .bi {
            font-size: 28px;
            color: var(--primary-color);
        }

        .quick-add-btn .bi {
            font-size: 20px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animation-fade-in {
            animation: fadeIn 0.7s ease-out 0.1s backwards;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        /* Header Styles */
        .header-sticky-container {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .header {
            height: 80px;
        }

        .header-icon {
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .header-icon i {
            font-size: 24px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo {
            background-image: var(--logo-url);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        /* Custom Card Style */
        .card {
            border-radius: var(--radius-large);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 var(--shadow-color) !important;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Product Item Styles */
        .product-item .icon-wrapper,
        .product-item-placeholder .icon-wrapper {
            box-shadow:
                inset 4px 4px 8px #d4e3ea,
                inset -4px -4px 8px #ffffff;
        }

        .product-item,
        .product-item-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            position: relative;
            background: transparent;
            border: none;
        }

        .product-item[role="button"] {
            cursor: pointer;
        }

        .product-item[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .product-text {
            font-size: 0.65rem;
            font-weight: 500;
            color: inherit;
            min-height: 2.5em;
            line-height: 1.25;
            width: 100%;
            padding: 0 2px;
            word-break: break-word;
        }

        /* Katalog Section Styles */
        .katalog-product-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .katalog-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px var(--shadow-color) !important;
        }

        .katalog-product-card .product-image-container {
            height: 150px;
            background-color: #f7fafc;
        }

        .katalog-product-card .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
        }

        .katalog-product-card .product-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .katalog-product-card .product-price {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .katalog-product-card .quick-add-btn {
            width: 36px;
            height: 36px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary-color);
            box-shadow: none;
            transition:
                transform 0.2s ease-in-out,
                background-color 0.2s ease-in-out,
                color 0.2s ease-in-out;
            flex-shrink: 0;
        }

        .katalog-product-card .quick-add-btn:hover {
            transform: scale(1.1);
            background-color: var(--primary-color);
            color: white;
        }

        @keyframes fly-to-cart {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(0.1);
                opacity: 0;
            }
        }

        .fly-to-cart-animation {
            position: fixed;
            z-index: 1100;
            border-radius: 50%;
            transition: all 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53);
            animation: fly-to-cart 0.5s ease-in forwards;
        }

        @keyframes shake-cart {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .shake {
            animation: shake-cart 0.82s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }

        .neumorph-element {
            background: var(--bg-primary);
            border-radius: 12px;
            border: none;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            box-shadow:
                5px 5px 10px #d4e3ea,
                -5px -5px 10px #ffffff;
            transition: box-shadow 0.2s ease-in-out;
            color: var(--text-primary);
            width: 100%;
        }

        .neumorph-element::placeholder {
            color: var(--text-secondary);
        }

        .neumorph-element:focus {
            outline: none;
            box-shadow:
                inset 5px 5px 10px #d4e3ea,
                inset -5px -5px 10px #ffffff;
        }

        select.neumorph-element {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        /* Download Button Styles */
        .download-app-section {
            margin-bottom: 1rem;
            animation: fadeIn 0.7s ease-out 0.2s backwards;
        }

        .download-app-card {
            background: linear-gradient(135deg, #008ca7 0%, #006b80 100%);
            border-radius: var(--radius-large);
            padding: 1rem;
            color: white;
            box-shadow: 0 8px 32px 0 rgba(0, 100, 120, 0.2);
        }

        .download-app-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .app-icon {
            width: 100px;
            height: 100px;
            background-color: transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            padding: 0px;
            margin-bottom: -10px;
        }

        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 0px;
        }

        .app-info {
            flex-grow: 1;
        }

        .app-info h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .app-info p {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .download-btn {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
            flex-shrink: 0;
        }

        .download-btn:hover {
            background-color: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            color: var(--primary-dark);
        }

        @media (max-width: 575.98px) {
            #katalog-product-grid .katalog-product-card {
                flex-direction: row;
                align-items: stretch;
                height: auto !important;
            }

            #katalog-product-grid .katalog-product-card .product-image-container {
                width: 120px;
                height: auto;
                flex-shrink: 0;
                border-right: 1px solid var(--border-color);
                border-bottom: none;
                border-top-right-radius: 0;
                border-bottom-left-radius: var(--radius-large);
            }

            #katalog-product-grid .katalog-product-card .product-image {
                height: 100%;
                min-height: 130px;
            }

            #katalog-product-grid .katalog-product-card .card-body {
                padding: 0.75rem 1rem !important;
                text-align: left;
            }

            #katalog-product-grid .katalog-product-card .product-name {
                display: -webkit-box;
                -webkit-line-clamp: 4;
                line-clamp: 4;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-bottom: 0.25rem;
                min-height: 4.2em;
            }

            .download-app-content {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .app-info {
                text-align: center;
            }

            .download-btn {
                width: 100%;
                justify-content: center;
            }
        }

        .katalog-product-card .product-wholesale-price {
            font-size: 0.8rem;
            color: #16a34a;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }

        #filter-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2f7;
            color: var(--primary-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .filter-chip button {
            background: none;
            border: none;
            color: inherit;
            margin-left: 0.5rem;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
        }

        .skeleton-card {
            background-color: #fff;
            border-radius: var(--radius-large);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .skeleton-item {
            background: linear-gradient(to right,
                    #e2e8f0 8%,
                    #f0f3f7 18%,
                    #e2e8f0 33%);
            background-size: 2000px 100%;
            animation: shimmer 1.5s linear infinite;
        }

        .skeleton-img {
            height: 150px;
        }

        .skeleton-text {
            height: 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            border-radius: 50%;
            font-weight: bold;
        }

        .qty-input {
            width: 40px;
            text-align: center;
            border: none;
            background: transparent;
        }

        .action-icon-btn {
            color: var(--text-secondary);
            transition: color 0.2s;
            padding: 0.5rem;
            border-radius: 50%;
            background: transparent;
            border: none;
        }

        .action-icon-btn:hover {
            color: var(--primary-color);
            background-color: rgba(0, 0, 0, 0.05);
        }

        .action-icon-btn:focus {
            box-shadow: none !important;
        }

        .btn-filter-toggle {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 600;
            box-shadow:
                0 4px 6px -1px rgb(0 0 0 / 0.1),
                0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .btn-filter-toggle .bi-chevron-down {
            transition: transform 0.3s ease;
        }

        .btn-filter-toggle[aria-expanded="true"] .bi-chevron-down {
            transform: rotate(180deg);
        }

        .swal2-popup {
            border-radius: var(--radius-large) !important;
        }

        .swal2-confirm.btn-primary,
        .swal2-confirm {
            background-color: var(--primary-color) !important;
            border-radius: var(--radius-medium) !important;
        }
    </style>
</head>

<body class="min-vh-100">
    <div class="header-sticky-container sticky-top">
        <header class="header container-fluid p-3 d-flex justify-content-between align-items-center">
            <div class="h-100 w-50 header-logo"></div>
            <!-- Tombol refresh dan chat dihapus -->
        </header>
    </div>

    <main class="container-fluid p-3">
        <div id="greeting" class="text-white px-1 mb-2"></div>
        
        <!-- Section Download Aplikasi MDR Pulsa -->
        <section class="download-app-section animation-fade-in">
            <div class="download-app-card">
                <div class="download-app-content">
                    <div class="app-icon">
                        <img src="https://sp1453.serpul.co.id/img/asset/header-white-20240203101151.png" 
                             alt="MDR Pulsa Logo" 
                             onerror="this.src='https://placehold.co/150x150/e2e8f0/334155?text=App+Logo';">
                    </div>
                    <div class="app-info">
                        <h3>MDR Pulsa V24</h3>
                        <p>Download aplikasi MDR Pulsa untuk pengalaman belanja yang lebih mudah dan cepat!</p>
                    </div>
                    <a href="https://firebasestorage.googleapis.com/v0/b/mdr-store-45ddc.firebasestorage.app/o/Aplikasi%2FMDRPULSA_V24.apk?alt=media&token=3f20fb89-ba7a-4a2f-9711-900f17ab4784" 
                       class="download-btn" 
                       target="_blank"
                       download="MDRPULSA_V24.apk">
                        <i class="bi bi-download"></i>
                        Download
                    </a>
                </div>
            </div>
        </section>

        <section id="katalog-section" class="card animation-fade-in">
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-shop" style="
                                        font-size: 25px;
                                        color: var(--primary-color);
                                    "></i>
                            <h2 class="h5 fw-bold mb-0">
                                MDR Store
                            </h2>
                            <button id="wholesale-info-btn" class="btn p-0 action-icon-btn ms-1"
                                title="Informasi Harga Grosir">
                                <i class="bi bi-info-circle-fill" style="font-size: 22px"></i>
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-1">
                            <button id="manual-refresh-btn" class="btn p-0 action-icon-btn"
                                title="Sinkronisasi Produk">
                                <i class="bi bi-arrow-repeat" style="font-size: 25px"></i>
                            </button>
                            <button id="history-btn" class="btn p-0 action-icon-btn" title="Riwayat Transaksi">
                                <i class="bi bi-clock-history" style="font-size: 25px"></i>
                            </button>
                            <div id="katalog-cart-icon"
                                class="position-relative cursor-pointer p-2 action-icon-btn">
                                <i class="bi bi-cart-plus-fill" style="font-size: 25px"></i>
                                <span id="katalog-cart-count"
                                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                    style="display: none">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="ps-4 ms-2">
                        <small id="katalog-last-update" class="text-muted" style="font-size: 0.65rem">Memuat
                            data...</small>
                    </div>
                </div>

                <div id="katalog-search-bar" class="mb-3">
                    <input type="text" id="katalog-search-input" class="neumorph-element"
                        placeholder="Cari produk di MDR Store..." />
                </div>

                <div id="filter-chips-container"></div>

                <div class="d-grid mb-3">
                    <button class="btn btn-filter-toggle" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseFilters" aria-expanded="false" aria-controls="collapseFilters">
                        Filter & Urutkan
                        <i class="bi bi-chevron-down ms-2"></i>
                    </button>
                </div>

                <div class="collapse" id="collapseFilters">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="katalog-brand-filter" class="filter-label">Filter Brand</label>
                            <select id="katalog-brand-filter" class="neumorph-element"></select>
                        </div>
                        <div class="col-md-6">
                            <label for="katalog-category-filter" class="filter-label">Filter Kategori</label>
                            <select id="katalog-category-filter" class="neumorph-element"></select>
                        </div>
                        <div class="col-12">
                            <label for="katalog-sort-filter" class="filter-label">Urutkan</label>
                            <select id="katalog-sort-filter" class="neumorph-element"></select>
                        </div>
                    </div>
                </div>

                <div id="katalog-product-grid"
                    class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 mt-3">
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Structures -->
    <div class="modal fade" id="katalog-detail-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" id="katalog-detail-modal-content"></div>
        </div>
    </div>

    <div class="modal fade" id="katalog-history-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content" id="katalog-history-modal-content"></div>
        </div>
    </div>

    <div class="modal fade" id="katalog-checkout-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" id="katalog-checkout-modal-content"></div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="katalog-cart-sidebar" aria-labelledby="cartSidebarLabel">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="cartSidebarLabel">
                Keranjang Belanja
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body" id="cart-offcanvas-body"></div>
        <div class="p-3 border-top bg-light" id="cart-offcanvas-footer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script type="module">
        window.MDRApp = (function () {
            // State & Config
            const _state = {
                katalogProducts: [],
                katalogCart:
                    JSON.parse(localStorage.getItem("katalogCart")) || [],
                katalogHistory: [],
                selectedKatalogProduct: null,
                bsModals: {},
                bsOffcanvas: {},
                activeModalListeners: new Map()
            };

            // PERBAIKAN: Ubah blok konfigurasi sesuai permintaan
            const _config = {
                API_BASE_URL: "https://script.google.com/macros/s/AKfycbzBMAn0BqWu2SGNETITqqDHYpGkPEgEYex6wnkg8T-Ms4SnswDsqHV5Sk2I6DDjSxupTg/exec",
                API_KEY: "MDR-DEMO",
                REGION_API_URL: "https://www.emsifa.com/api-wilayah-indonesia/api",
                UPDATE_INTERVAL_MINUTES: 5,
                GROSIR_RULES: {
                    BY_QUANTITY: {
                        CATEGORIES: ["voucher internet", "kartu perdana"],
                        THRESHOLD: 150
                    },
                    BY_VALUE: { THRESHOLD: 500000 }
                },
                COD_ENABLED: true,
                FLAT_SHIPPING_RATE: 12000
            };

            const _helpers = {
                formatCurrency: (amount, withRp = true) => {
                    const number = Number(amount) || 0;
                    return new Intl.NumberFormat("id-ID", {
                        style: withRp ? "currency" : "decimal",
                        currency: "IDR",
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(number);
                },
                debounce: (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },
                validatePhone: (phone) => {
                    const phoneRegex = /^[0-9]{10,13}$/;
                    return phoneRegex.test(phone.replace(/\D/g, ''));
                },
                showError: (message, title = "Terjadi Kesalahan") => {
                    console.error(`${title}:`, message);
                    Swal.fire({
                        title: title,
                        text: message,
                        icon: "error",
                        confirmButtonText: "Mengerti"
                    });
                }
            };

            // UI Module dengan improvements
            const _uiModule = {
                init() {
                    const modalIds = [
                        "katalog-detail-modal",
                        "katalog-checkout-modal",
                        "katalog-history-modal"
                    ];

                    modalIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && window.bootstrap) {
                            _state.bsModals[id] = new window.bootstrap.Modal(el);

                            // Cleanup listeners ketika modal ditutup
                            el.addEventListener('hidden.bs.modal', () => {
                                this.cleanupModalListeners(id);
                            });
                        }
                    });

                    const cartEl = document.getElementById("katalog-cart-sidebar");
                    if (cartEl && window.bootstrap) {
                        _state.bsOffcanvas.cart = new window.bootstrap.Offcanvas(cartEl);
                    }
                },

                showModal(id) {
                    if (_state.bsModals[id]) {
                        _state.bsModals[id].show();
                    }
                },

                hideModal(id) {
                    if (_state.bsModals[id]) {
                        this.cleanupModalListeners(id);
                        _state.bsModals[id].hide();
                    }
                },

                showOffcanvas(id) {
                    if (_state.bsOffcanvas[id]) {
                        _state.bsOffcanvas[id].show();
                    }
                },

                hideOffcanvas(id) {
                    if (_state.bsOffcanvas[id]) {
                        _state.bsOffcanvas[id].hide();
                    }
                },

                cleanupModalListeners(modalId) {
                    const listeners = _state.activeModalListeners.get(modalId);
                    if (listeners) {
                        listeners.forEach(({ element, event, handler }) => {
                            element.removeEventListener(event, handler);
                        });
                        _state.activeModalListeners.delete(modalId);
                    }
                },

                registerModalListener(modalId, element, event, handler) {
                    if (!_state.activeModalListeners.has(modalId)) {
                        _state.activeModalListeners.set(modalId, []);
                    }

                    const listeners = _state.activeModalListeners.get(modalId);
                    listeners.push({ element, event, handler });
                    element.addEventListener(event, handler);
                }
            };

            // Region Module dengan error handling yang lebih baik
            const _regionModule = {
                async fetchData(endpoint) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);

                        const response = await fetch(
                            `${_config.REGION_API_URL}/${endpoint}`,
                            { signal: controller.signal }
                        );

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        return await response.json();
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.warn(`Request timeout for ${endpoint}`);
                        } else {
                            console.error(`Error fetching ${endpoint}:`, error);
                        }
                        return [];
                    }
                },

                populateSelect(elementId, data, defaultOptionText) {
                    const selectEl = document.getElementById(elementId);
                    if (!selectEl) return;

                    selectEl.innerHTML = `<option value="">-- Pilih ${defaultOptionText} --</option>`;
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        selectEl.appendChild(option);
                    });
                    selectEl.disabled = false;
                },

                resetSelect(elementId, defaultOptionText) {
                    const selectEl = document.getElementById(elementId);
                    if (!selectEl) return;

                    selectEl.innerHTML = `<option value="">-- Pilih ${defaultOptionText} --</option>`;
                    selectEl.disabled = true;
                },

                async initProvinces() {
                    try {
                        const provinces = await this.fetchData("provinces.json");
                        if (provinces.length > 0) {
                            this.populateSelect("customer-province", provinces, "Provinsi");
                        } else {
                            this.showFallbackInput("customer-province", "Provinsi");
                        }
                    } catch (error) {
                        this.showFallbackInput("customer-province", "Provinsi");
                    }
                },

                showFallbackInput(elementId, label) {
                    const selectEl = document.getElementById(elementId);
                    if (!selectEl) return;

                    const parent = selectEl.parentElement;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = selectEl.className;
                    input.placeholder = `Masukkan ${label}`;
                    input.id = `${elementId}-fallback`;

                    parent.replaceChild(input, selectEl);
                },

                async onProvinceChange(provinceId) {
                    this.resetSelect("customer-regency", "Kabupaten/Kota");
                    this.resetSelect("customer-district", "Kecamatan");

                    if (provinceId) {
                        try {
                            const regencies = await this.fetchData(`regencies/${provinceId}.json`);
                            if (regencies.length > 0) {
                                this.populateSelect("customer-regency", regencies, "Kabupaten/Kota");
                            } else {
                                this.showFallbackInput("customer-regency", "Kabupaten/Kota");
                            }
                        } catch (error) {
                            this.showFallbackInput("customer-regency", "Kabupaten/Kota");
                        }
                    }
                },

                async onRegencyChange(regencyId) {
                    this.resetSelect("customer-district", "Kecamatan");

                    if (regencyId) {
                        try {
                            const districts = await this.fetchData(`districts/${regencyId}.json`);
                            if (districts.length > 0) {
                                this.populateSelect("customer-district", districts, "Kecamatan");
                            } else {
                                this.showFallbackInput("customer-district", "Kecamatan");
                            }
                        } catch (error) {
                            this.showFallbackInput("customer-district", "Kecamatan");
                        }
                    }
                }
            };

            // Greeting Module
            const _greetingModule = {
                init() {
                    const greetingEl = document.getElementById("greeting");
                    if (!greetingEl) return;

                    const hours = new Date().getHours();
                    let timeOfDay = "Pagi";

                    if (hours < 11) timeOfDay = "Pagi";
                    else if (hours < 15) timeOfDay = "Siang";
                    else if (hours < 19) timeOfDay = "Sore";
                    else timeOfDay = "Malam";

                    greetingEl.innerHTML = `<h1 class="h5 fw-bold mb-0">Selamat ${timeOfDay}, Juragan!</h1>`;
                }
            };

            // Katalog Module dengan improvements besar
            const _katalogModule = {
                elements: {},
                isInitialized: false,

                init() {
                    if (this.isInitialized) {
                        console.warn("Katalog module already initialized");
                        return;
                    }

                    console.log("Katalog Module Initialized");
                    this.elements = {
                        productGrid: document.getElementById("katalog-product-grid"),
                        searchInput: document.getElementById("katalog-search-input"),
                        brandFilter: document.getElementById("katalog-brand-filter"),
                        categoryFilter: document.getElementById("katalog-category-filter"),
                        sortFilter: document.getElementById("katalog-sort-filter"),
                        filterChipsContainer: document.getElementById("filter-chips-container"),
                        cartIcon: document.getElementById("katalog-cart-icon"),
                        cartCount: document.getElementById("katalog-cart-count"),
                        cartBody: document.getElementById("cart-offcanvas-body"),
                        cartFooter: document.getElementById("cart-offcanvas-footer"),
                        lastUpdateElement: document.getElementById("katalog-last-update"),
                        manualRefreshBtn: document.getElementById("manual-refresh-btn"),
                        historyBtn: document.getElementById("history-btn"),
                        wholesaleInfoBtn: document.getElementById("wholesale-info-btn")
                    };

                    this.addEventListeners();
                    this.createSortDropdown();
                    this.updateCartCount();
                    this.loadHistory();
                    
                    // PERUBAHAN PENTING: Selalu ambil data fresh, jangan gunakan cache
                    console.log("Memuat data produk fresh dari API...");
                    this.showSkeletonLoader();
                    this.fetchAndUpdateProducts();

                    this.isInitialized = true;
                },

                addEventListeners() {
                    // Debounced search for better performance
                    if (this.elements.searchInput) {
                        const debouncedSearch = _helpers.debounce(() => this.filterAndRender(), 300);
                        this.elements.searchInput.addEventListener("input", debouncedSearch);
                    }

                    if (this.elements.brandFilter) {
                        this.elements.brandFilter.addEventListener("change", () => this.filterAndRender());
                    }

                    if (this.elements.categoryFilter) {
                        this.elements.categoryFilter.addEventListener("change", () => this.filterAndRender());
                    }

                    if (this.elements.sortFilter) {
                        this.elements.sortFilter.addEventListener("change", () => this.filterAndRender());
                    }

                    if (this.elements.cartIcon) {
                        this.elements.cartIcon.addEventListener("click", () => this.toggleCart(true));
                    }

                    if (this.elements.historyBtn) {
                        this.elements.historyBtn.addEventListener("click", () => this.showHistoryModal());
                    }

                    if (this.elements.manualRefreshBtn) {
                        this.elements.manualRefreshBtn.addEventListener("click", () => {
                            const icon = this.elements.manualRefreshBtn.querySelector("i");
                            if (icon) {
                                icon.classList.add("animate-spin");
                            }
                            this.fetchAndUpdateProducts().finally(() => {
                                if (icon) {
                                    icon.classList.remove("animate-spin");
                                }
                            });
                        });
                    }

                    if (this.elements.wholesaleInfoBtn) {
                        this.elements.wholesaleInfoBtn.addEventListener("click", () => this.showWholesaleInfo());
                    }
                },

                loadProductsFromCache() {
                    try {
                        const cachedData = localStorage.getItem("katalogProductsCache");
                        if (cachedData) {
                            _state.katalogProducts = JSON.parse(cachedData);
                            this.createFilterDropdowns();
                            this.filterAndRender();
                            this.displayLastUpdateTime();
                        }
                    } catch (e) {
                        console.error("Gagal memuat produk dari cache:", e);
                        _state.katalogProducts = [];
                    }
                },

                shouldUpdate() {
                    // PERUBAHAN: Selalu return true untuk memaksa update dari API
                    return true;
                },

                displayLastUpdateTime() {
                    if (!this.elements.lastUpdateElement) return;

                    const lastUpdate = localStorage.getItem("katalogLastUpdate");
                    if (lastUpdate) {
                        const date = new Date(parseInt(lastUpdate, 10));
                        this.elements.lastUpdateElement.textContent = `Diperbarui: ${date
                            .toLocaleString("id-ID", {
                                day: "numeric",
                                month: "short",
                                year: "numeric",
                                hour: "2-digit",
                                minute: "2-digit"
                            })
                            .replace(/\./g, ":")} WIB`;
                    } else {
                        this.elements.lastUpdateElement.textContent = "Memuat produk...";
                    }
                },

                // PERBAIKAN: Fungsi fetchAndUpdateProducts yang sudah diperbaiki
                async fetchAndUpdateProducts() {
                    this.showSkeletonLoader();

                    try {
                        // Hapus cache lama
                        const cacheKey = "katalogProductsCache";
                        const lastUpdateKey = "katalogLastUpdate";
                        localStorage.removeItem(cacheKey);
                        localStorage.removeItem(lastUpdateKey);

                        // Susun URL dengan URLSearchParams
                        const params = new URLSearchParams({
                            key: _config.API_KEY,
                            action: "get_products"
                        });

                        const apiUrl = `${_config.API_BASE_URL}?${params.toString()}`;
                        console.log("Fetching from URL:", apiUrl);

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000);

                        const response = await fetch(apiUrl, {
                            signal: controller.signal,
                            cache: 'no-cache'
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const textData = await response.text();
                        console.log("Raw API Response:", textData.substring(0, 500) + "...");

                        // Handle JSON parsing dengan aman
                        let jsonText;
                        try {
                            const jsonMatch = textData.match(/\{.*\}/s);
                            if (jsonMatch) {
                                jsonText = jsonMatch[0];
                            } else {
                                jsonText = textData;
                            }
                            
                            const data = JSON.parse(jsonText);
                            console.log("Parsed Data Structure:", data);

                            if (data.status === "success" && Array.isArray(data.data)) {
                                const newProducts = data.data
                                    .map(p => ({
                                        ...p,
                                        harga_retail: parseFloat(p.harga_retail) || 0,
                                        harga_grosir: parseFloat(p.harga_grosir) || 0,
                                        min_qty_grosir: parseInt(p.min_qty_grosir, 10) || 0
                                    }))
                                    .filter(p => p.nama_produk && p.harga_retail > 0);

                                console.log("Processed Products Count:", newProducts.length);
                                console.log("Sample Product:", newProducts[0]);

                                _state.katalogProducts = newProducts;

                                try {
                                    localStorage.setItem(cacheKey, JSON.stringify(_state.katalogProducts));
                                    localStorage.setItem(lastUpdateKey, new Date().getTime().toString());
                                    console.log("Data successfully cached");
                                } catch (storageError) {
                                    console.warn("Storage is full, cannot cache products:", storageError);
                                }

                                this.createFilterDropdowns();
                                this.filterAndRender();
                                this.displayLastUpdateTime();
                                
                                // Show success message
                                if (this.elements.lastUpdateElement) {
                                    this.elements.lastUpdateElement.textContent = "Data berhasil diperbarui!";
                                }
                            } else {
                                throw new Error("Invalid data structure from API: " + JSON.stringify(data));
                            }
                        } catch (parseError) {
                            console.error("JSON Parse Error:", parseError);
                            console.error("Raw response that failed to parse:", textData);
                            throw new Error("Gagal memproses data dari server");
                        }
                    } catch (error) {
                        console.error("Error fetching catalog products:", error);

                        if (this.elements.lastUpdateElement) {
                            this.elements.lastUpdateElement.textContent = "Gagal memuat data baru.";
                        }

                        // JANGAN gunakan cache lama - biarkan kosong atau tampilkan error
                        if (_state.katalogProducts.length === 0 && this.elements.productGrid) {
                            this.showErrorState("Gagal memuat data produk. Silakan refresh halaman.");
                        }

                        Swal.fire({
                            icon: "error",
                            title: "Gagal Memuat Data",
                            text: "Tidak dapat terhubung ke server. Silakan coba beberapa saat lagi.",
                            confirmButtonText: "Mengerti"
                        });
                    }
                },

                createFilterDropdowns() {
                    if (!this.elements.brandFilter || !this.elements.categoryFilter) return;

                    try {
                        const brands = ["all", ...new Set(_state.katalogProducts
                            .map(p => p.brand)
                            .filter(Boolean)
                            .sort())];

                        this.elements.brandFilter.innerHTML = brands
                            .map(brand => `<option value="${brand.toLowerCase()}">${brand === "all" ? "Semua Brand" : brand}</option>`)
                            .join("");

                        const categories = ["all", ...new Set(_state.katalogProducts
                            .map(p => p.nama_kategori)
                            .filter(Boolean)
                            .sort())];

                        this.elements.categoryFilter.innerHTML = categories
                            .map(cat => `<option value="${cat.toLowerCase()}">${cat === "all" ? "Semua Kategori" : cat}</option>`)
                            .join("");
                    } catch (error) {
                        console.error("Error creating filter dropdowns:", error);
                    }
                },

                createSortDropdown() {
                    if (!this.elements.sortFilter) return;

                    const sortOptions = {
                        default: "Urutan Standar",
                        "price-asc": "Harga Terendah",
                        "price-desc": "Harga Tertinggi",
                        "name-asc": "Nama A-Z",
                        "name-desc": "Nama Z-A"
                    };

                    this.elements.sortFilter.innerHTML = Object.entries(sortOptions)
                        .map(([value, text]) => `<option value="${value}">${text}</option>`)
                        .join("");
                },

                filterAndRender() {
                    if (!this.elements.productGrid || !Array.isArray(_state.katalogProducts)) {
                        console.warn('Product grid or katalogProducts not ready');
                        return;
                    }

                    const searchTerm = this.elements.searchInput?.value.toLowerCase() || "";
                    const activeBrand = this.elements.brandFilter?.value || "all";
                    const activeCategory = this.elements.categoryFilter?.value || "all";
                    const activeSort = this.elements.sortFilter?.value || "default";

                    this.renderFilterChips(activeBrand, activeCategory);

                    let filteredProducts = _state.katalogProducts.filter(p => {
                        const matchesBrand = activeBrand === "all" ||
                            (p.brand || "").toLowerCase() === activeBrand;
                        const matchesCategory = activeCategory === "all" ||
                            (p.nama_kategori || "").toLowerCase() === activeCategory;
                        const matchesSearch = searchTerm === "" ||
                            p.nama_produk.toLowerCase().includes(searchTerm) ||
                            (p.kode_produk || "").toLowerCase().includes(searchTerm) ||
                            (p.brand || "").toLowerCase().includes(searchTerm);

                        return matchesBrand && matchesCategory && matchesSearch;
                    });

                    // Sort products
                    switch (activeSort) {
                        case "price-asc":
                            filteredProducts.sort((a, b) => a.harga_retail - b.harga_retail);
                            break;
                        case "price-desc":
                            filteredProducts.sort((a, b) => b.harga_retail - a.harga_retail);
                            break;
                        case "name-asc":
                            filteredProducts.sort((a, b) => a.nama_produk.localeCompare(b.nama_produk));
                            break;
                        case "name-desc":
                            filteredProducts.sort((a, b) => b.nama_produk.localeCompare(a.nama_produk));
                            break;
                    }

                    this.renderProducts(filteredProducts);
                },

                renderProducts(products) {
                    if (!this.elements.productGrid) return;

                    try {
                        if (products.length === 0 && _state.katalogProducts.length > 0) {
                            this.elements.productGrid.innerHTML = `
                                    <div class="col-12">
                                        <div class="text-center text-muted py-5">
                                            <i class="bi bi-search display-4 d-block mb-3"></i>
                                            <p class="mb-0">Produk tidak ditemukan.</p>
                                            <small>Coba gunakan kata kunci lain atau hapus filter.</small>
                                        </div>
                                    </div>`;
                            return;
                        }

                        if (products.length === 0 && _state.katalogProducts.length === 0) {
                            this.showErrorState("Belum ada produk yang tersedia.");
                            return;
                        }

                        const fragment = document.createDocumentFragment();

                        products.forEach(product => {
                            const cardContainer = document.createElement("div");
                            cardContainer.className = "col";
                            cardContainer.innerHTML = this.createProductCardHTML(product);
                            fragment.appendChild(cardContainer);
                        });

                        this.elements.productGrid.innerHTML = '';
                        this.elements.productGrid.appendChild(fragment);

                        // Attach event listeners to new elements
                        this.attachProductEventListeners();
                    } catch (error) {
                        console.error("Error rendering products:", error);
                        this.showErrorState("Terjadi kesalahan saat menampilkan produk.");
                    }
                },

                createProductCardHTML(product) {
                    return `
                            <div class="card h-100 katalog-product-card">
                                <div class="product-image-container card-img-top">
                                    <img src="${product.gambar_url || "https://placehold.co/150x150/e2e8f0/334155?text=No+Image"}" 
                                         class="product-image" alt="${product.nama_produk}" loading="lazy"
                                         onerror="this.src='https://placehold.co/150x150/e2e8f0/334155?text=Gambar+Error';">
                                </div>
                                <div class="card-body d-flex flex-column p-3">
                                    <h3 class="product-name card-title">${product.nama_produk}</h3>
                                    <div class="price-section mt-auto pt-2 d-flex justify-content-between align-items-end">
                                        <div>
                                            <p class="product-price mb-0">${_helpers.formatCurrency(product.harga_retail, true)}</p>
                                            ${product.harga_grosir > 0 ?
                            `<p class="product-wholesale-price mb-0">Grosir: ${_helpers.formatCurrency(product.harga_grosir, true)}</p>` :
                            ''}
                                        </div>
                                        <button class="quick-add-btn" data-product-id="${product.kode_produk}">
                                            <i class="bi bi-cart-plus-fill"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                },

                attachProductEventListeners() {
                    const cards = this.elements.productGrid.querySelectorAll('.katalog-product-card');

                    cards.forEach(card => {
                        // Click on card to show details
                        card.addEventListener('click', (e) => {
                            // Don't trigger if quick add button was clicked
                            if (e.target.closest('.quick-add-btn')) {
                                return;
                            }

                            const productName = card.querySelector('.product-name')?.textContent;
                            const product = _state.katalogProducts.find(p => p.nama_produk === productName);

                            if (product) {
                                this.showDetailModal(product);
                            }
                        });

                        // Quick add button
                        const quickAddBtn = card.querySelector('.quick-add-btn');
                        if (quickAddBtn) {
                            const productId = quickAddBtn.getAttribute('data-product-id');
                            const product = _state.katalogProducts.find(p => p.kode_produk === productId);

                            if (product) {
                                quickAddBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    this.addToCartFromCard(product, card.querySelector('.product-image'));
                                });
                            }
                        }
                    });
                },

                renderFilterChips(activeBrand, activeCategory) {
                    const container = this.elements.filterChipsContainer;
                    if (!container) return;

                    container.innerHTML = "";

                    if (activeBrand !== "all") {
                        const brandText = this.elements.brandFilter?.options[this.elements.brandFilter.selectedIndex]?.text || activeBrand;
                        container.innerHTML += `
                                <div class="filter-chip">
                                    Brand: ${brandText}
                                    <button onclick="MDRApp.removeFilter('brand')">&times;</button>
                                </div>`;
                    }

                    if (activeCategory !== "all") {
                        const categoryText = this.elements.categoryFilter?.options[this.elements.categoryFilter.selectedIndex]?.text || activeCategory;
                        container.innerHTML += `
                                <div class="filter-chip">
                                    Kategori: ${categoryText}
                                    <button onclick="MDRApp.removeFilter('category')">&times;</button>
                                </div>`;
                    }
                },

                showWholesaleInfo() {
                    const { BY_QUANTITY, BY_VALUE } = _config.GROSIR_RULES;

                    Swal.fire({
                        title: "<strong>Informasi Harga Grosir</strong>",
                        icon: "info",
                        html: `
                                <p class="text-start">Kami memiliki 2 jenis aturan harga grosir yang berbeda:</p>
                                <div class="alert alert-info text-start">
                                    <h6 class="alert-heading">1. Grup Kuantitas</h6>
                                    <p class="mb-0">Berlaku untuk produk kategori <b>${BY_QUANTITY.CATEGORIES.join(" & ")}</b>.</p>
                                    <hr>
                                    <p class="mb-0">Harga grosir aktif jika total pembelian gabungan dari kategori tersebut mencapai min. <b>${BY_QUANTITY.THRESHOLD} pcs</b>.</p>
                                </div>
                                <div class="alert alert-success text-start">
                                    <h6 class="alert-heading">2. Grup Nilai Belanja</h6>
                                    <p class="mb-0">Berlaku untuk semua produk lain (Aksesoris, Kabel, dll).</p>
                                    <hr>
                                    <p class="mb-0">Harga grosir aktif jika total belanja gabungan dari produk-produk ini mencapai min. <b>${_helpers.formatCurrency(BY_VALUE.THRESHOLD)}</b>.</p>
                                </div>
                            `,
                        showCloseButton: true,
                        confirmButtonText: "Mengerti"
                    });
                },

                showSkeletonLoader() {
                    if (!this.elements.productGrid) return;

                    const skeletonHTML = Array(8).fill(`
                            <div class="col">
                                <div class="skeleton-card">
                                    <div class="skeleton-item skeleton-img"></div>
                                    <div class="p-3">
                                        <div class="skeleton-item skeleton-text w-100"></div>
                                        <div class="skeleton-item skeleton-text w-75"></div>
                                    </div>
                                </div>
                            </div>
                        `).join('');

                    this.elements.productGrid.innerHTML = skeletonHTML;
                },

                showErrorState(message) {
                    if (!this.elements.productGrid) return;

                    this.elements.productGrid.innerHTML = `
                            <div class="col-12">
                                <div class="text-center text-danger py-5">
                                    <i class="bi bi-exclamation-triangle display-4 d-block mb-3"></i>
                                    <p class="mb-0">${message}</p>
                                    <button class="btn btn-primary mt-3" onclick="MDRApp.forceRefreshKatalog()">
                                        <i class="bi bi-arrow-repeat me-2"></i>Coba Lagi
                                    </button>
                                </div>
                            </div>`;
                },

                parseDescription(desc) {
                    if (!desc) {
                        return '<p class="text-muted fst-italic">Deskripsi untuk produk ini belum tersedia.</p>';
                    }

                    if (desc.includes("")) {
                        const items = desc.split("")
                            .map(item => item.trim())
                            .filter(Boolean)
                            .map(item => `<li> ${item}</li>`)
                            .join("");
                        return `<ul class="list-unstyled ps-3">${items}</ul>`;
                    }

                    return `<p>${desc.replace(/\n/g, "<br>")}</p>`;
                },

                _calculateFinalCart() {
                    const { BY_QUANTITY, BY_VALUE } = _config.GROSIR_RULES;
                    let qtyGroupTotalQty = 0,
                        valGroupPotentialTotal = 0;

                    _state.katalogCart.forEach(item => {
                        const categoryLower = (item.nama_kategori || "").toLowerCase();
                        if (BY_QUANTITY.CATEGORIES.includes(categoryLower)) {
                            qtyGroupTotalQty += item.qty;
                        } else {
                            valGroupPotentialTotal += (item.harga_grosir > 0 ? item.harga_grosir : item.harga_retail) * item.qty;
                        }
                    });

                    const isQtyWholesaleMet = qtyGroupTotalQty >= BY_QUANTITY.THRESHOLD;
                    const isValWholesaleMet = valGroupPotentialTotal >= BY_VALUE.THRESHOLD;
                    let finalTotal = 0;

                    const items = _state.katalogCart.map(item => {
                        let priceToUse = item.harga_retail,
                            wholesaleApplied = false;
                        const categoryLower = (item.nama_kategori || "").toLowerCase();

                        if (item.harga_grosir > 0) {
                            if ((BY_QUANTITY.CATEGORIES.includes(categoryLower) && isQtyWholesaleMet) ||
                                (!BY_QUANTITY.CATEGORIES.includes(categoryLower) && isValWholesaleMet)) {
                                priceToUse = item.harga_grosir;
                                wholesaleApplied = true;
                            }
                        }

                        finalTotal += priceToUse * item.qty;
                        return {
                            ...item,
                            finalPrice: priceToUse,
                            wholesaleApplied
                        };
                    });

                    return {
                        isQtyWholesaleMet,
                        isValWholesaleMet,
                        qtyGroupTotalQty,
                        valGroupPotentialTotal,
                        finalTotal,
                        items
                    };
                },

                _flyToCartAnimation(targetElement) {
                    const cartIcon = this.elements.cartIcon;
                    if (!targetElement || !cartIcon) return;

                    const targetRect = targetElement.getBoundingClientRect();
                    const flyingEl = targetElement.cloneNode(true);
                    flyingEl.classList.add("fly-to-cart-animation");
                    document.body.appendChild(flyingEl);

                    flyingEl.style.cssText = `
                            position: fixed;
                            top: ${targetRect.top}px;
                            left: ${targetRect.left}px;
                            width: ${targetRect.width}px;
                            height: ${targetRect.height}px;
                            z-index: 1100;
                        `;

                    // Trigger reflow
                    flyingEl.getBoundingClientRect();

                    const cartRect = cartIcon.getBoundingClientRect();
                    flyingEl.style.top = `${cartRect.top}px`;
                    flyingEl.style.left = `${cartRect.left}px`;

                    setTimeout(() => {
                        flyingEl.remove();
                        cartIcon.classList.add("shake");
                        setTimeout(() => cartIcon.classList.remove("shake"), 820);
                    }, 500);
                },

                addToCartFromCard(product, imageElement) {
                    const existingItem = _state.katalogCart.find(
                        item => item.kode_produk === product.kode_produk
                    );

                    if (existingItem) {
                        existingItem.qty += 1;
                    } else {
                        _state.katalogCart.push({ ...product, qty: 1 });
                    }

                    this.saveCart();
                    this.updateCartCount();
                    this._flyToCartAnimation(imageElement);

                    Swal.fire({
                        toast: true,
                        position: "top-end",
                        icon: "success",
                        title: `${product.nama_produk} ditambahkan!`,
                        showConfirmButton: false,
                        timer: 1500
                    });
                },

                addToCart() {
                    const qtyInput = document.getElementById("katalog-qty-input");
                    if (!qtyInput || !_state.selectedKatalogProduct) return;

                    const qty = parseInt(qtyInput.value, 10);
                    if (qty <= 0) return;

                    const existingItem = _state.katalogCart.find(
                        item => item.kode_produk === _state.selectedKatalogProduct.kode_produk
                    );

                    if (existingItem) {
                        existingItem.qty += qty;
                    } else {
                        _state.katalogCart.push({
                            ..._state.selectedKatalogProduct,
                            qty
                        });
                    }

                    this.saveCart();
                    this.updateCartCount();
                    _uiModule.hideModal("katalog-detail-modal");

                    this.elements.cartIcon.classList.add("shake");
                    setTimeout(() => this.elements.cartIcon.classList.remove("shake"), 820);

                    Swal.fire({
                        icon: "success",
                        title: "Berhasil!",
                        text: `${_state.selectedKatalogProduct.nama_produk} ditambahkan.`,
                        showConfirmButton: false,
                        timer: 1500
                    });
                },

                showDetailModal(product) {
                    _state.selectedKatalogProduct = product;
                    const modalContentEl = document.getElementById("katalog-detail-modal-content");
                    if (!modalContentEl) return;

                    try {
                        const cartData = this._calculateFinalCart();
                        const { BY_QUANTITY, BY_VALUE } = _config.GROSIR_RULES;
                        const categoryLower = (product.nama_kategori || "").toLowerCase();

                        let grosirNotification = "";
                        if (product.harga_grosir > 0) {
                            if (BY_QUANTITY.CATEGORIES.includes(categoryLower)) {
                                const qtyNeeded = BY_QUANTITY.THRESHOLD - cartData.qtyGroupTotalQty;
                                grosirNotification = qtyNeeded > 0 ?
                                    `<div class="alert alert-info text-center p-2 mt-3">Tambah <b>${qtyNeeded} pcs</b> lagi dari produk Voucher/Perdana untuk dapat harga grosir.</div>` :
                                    `<div class="alert alert-success text-center p-2 mt-3">Selamat! Harga grosir untuk grup Voucher/Perdana aktif.</div>`;
                            } else {
                                const amountNeeded = BY_VALUE.THRESHOLD - cartData.valGroupPotentialTotal;
                                grosirNotification = !cartData.isValWholesaleMet && amountNeeded > 0 ?
                                    `<div class="alert alert-info text-center p-2 mt-3">Belanja <b>${_helpers.formatCurrency(amountNeeded, true)}</b> lagi dari produk non-voucher untuk dapat harga grosir.</div>` :
                                    `<div class="alert alert-success text-center p-2 mt-3">Selamat! Harga grosir untuk grup produk ini aktif.</div>`;
                            }
                        }

                        const wholesalePriceHTML = product.harga_grosir > 0 ?
                            `<div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">Harga Grosir</span>
                                    <p class="text-success fw-bold mb-0">${_helpers.formatCurrency(product.harga_grosir, true)}</p>
                                </div>` : "";

                        modalContentEl.innerHTML = `
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold">Detail Produk</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="d-flex align-items-start gap-3 mb-3">
                                        <img src="${product.gambar_url || "https://placehold.co/150x150/e2e8f0/334155?text=No+Image"}" 
                                             alt="${product.nama_produk}" 
                                             class="w-25 h-auto object-fit-contain rounded border flex-shrink-0 bg-white"
                                             onerror="this.src='https://placehold.co/150x150/e2e8f0/334155?text=Gambar+Error';">
                                        <div class="flex-grow-1">
                                            <h4 class="h6 fw-bold lh-tight">${product.nama_produk}</h4>
                                            <div class="text-muted" style="font-size: 0.8rem;">
                                                <p class="mb-0"><b>Kode:</b> ${product.kode_produk || "-"}</p>
                                                <p class="mb-0"><b>Brand:</b> ${product.brand || "-"}</p>
                                                <p class="mb-0"><b>Kategori:</b> ${product.nama_kategori || "-"}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="h6 fw-semibold mb-1">Deskripsi</h5>
                                        <div class="text-muted" style="font-size: 0.9rem;">
                                            ${this.parseDescription(product.deskripsi)}
                                        </div>
                                    </div>
                                    <div class="bg-light p-3 rounded mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted fw-medium">Harga Satuan</span>
                                            <p class="text-primary fw-bold fs-5 mb-0">${_helpers.formatCurrency(product.harga_retail, true)}</p>
                                        </div>
                                        ${wholesalePriceHTML}
                                        <div class="d-flex justify-content-between align-items-center pt-2 border-top mt-3">
                                            <label for="katalog-qty-input" class="fw-medium text-muted">Kuantitas</label>
                                            <input type="number" id="katalog-qty-input" class="form-control text-center" style="width: 80px;" value="1" min="1">
                                        </div>
                                        ${grosirNotification}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                    <button type="button" class="btn btn-primary" id="add-to-cart-btn">Tambah ke Keranjang</button>
                                </div>`;

                        // Register event listener for the add to cart button
                        const addToCartBtn = modalContentEl.querySelector("#add-to-cart-btn");
                        if (addToCartBtn) {
                            _uiModule.registerModalListener(
                                "katalog-detail-modal",
                                addToCartBtn,
                                "click",
                                () => this.addToCart()
                            );
                        }

                        _uiModule.showModal("katalog-detail-modal");
                    } catch (error) {
                        console.error("Error showing detail modal:", error);
                        _helpers.showError("Gagal menampilkan detail produk");
                    }
                },

                updateCartCount() {
                    const totalItems = _state.katalogCart.reduce((sum, item) => sum + item.qty, 0);

                    if (this.elements.cartCount) {
                        this.elements.cartCount.textContent = totalItems;
                        this.elements.cartCount.style.display = totalItems > 0 ? "inline-block" : "none";
                    }
                },

                toggleCart(show) {
                    if (show) {
                        this.renderCartItems();
                        _uiModule.showOffcanvas("cart");
                    } else {
                        _uiModule.hideOffcanvas("cart");
                    }
                },

                renderCartItems() {
                    if (!this.elements.cartBody || !this.elements.cartFooter) return;

                    try {
                        const cartData = this._calculateFinalCart();
                        const { BY_QUANTITY, BY_VALUE } = _config.GROSIR_RULES;

                        let grosirNotificationsCart = "";

                        if (_state.katalogCart.some(item =>
                            BY_QUANTITY.CATEGORIES.includes((item.nama_kategori || "").toLowerCase())) &&
                            !cartData.isQtyWholesaleMet) {
                            grosirNotificationsCart += `
                                    <div class="alert alert-info p-2 mb-2">
                                        Tambah <b>${BY_QUANTITY.THRESHOLD - cartData.qtyGroupTotalQty} pcs</b> 
                                        lagi dari produk Voucher/Perdana untuk dapat harga grosir.
                                    </div>`;
                        }

                        if (_state.katalogCart.some(item =>
                            !BY_QUANTITY.CATEGORIES.includes((item.nama_kategori || "").toLowerCase())) &&
                            !cartData.isValWholesaleMet) {
                            const amountNeeded = BY_VALUE.THRESHOLD - cartData.valGroupPotentialTotal;
                            if (amountNeeded > 0) {
                                grosirNotificationsCart += `
                                        <div class="alert alert-warning p-2 mb-2">
                                            Belanja <b>${_helpers.formatCurrency(amountNeeded, true)}</b> 
                                            lagi dari produk lainnya untuk dapat harga grosir.
                                        </div>`;
                            }
                        }

                        const cartHtml = cartData.items.length > 0 ?
                            cartData.items.map((item, index) => {
                                const wholesaleBadge = item.wholesaleApplied ?
                                    `<span class="badge bg-success ms-1" style="font-size: 0.6rem; vertical-align: middle;">Grosir</span>` : "";
                                const priceDisplay = item.wholesaleApplied ?
                                    `<p class="mb-0" style="font-size:0.8rem;">
                                            <span class="text-success fw-bold">${_helpers.formatCurrency(item.finalPrice, true)}</span> 
                                            <s class="text-muted">${_helpers.formatCurrency(item.harga_retail, true)}</s>
                                        </p>` :
                                    `<p class="text-muted mb-0" style="font-size:0.8rem;">${_helpers.formatCurrency(item.finalPrice, true)}</p>`;

                                return `
                                        <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                                            <div class="flex-grow-1 pe-2">
                                                <p class="fw-semibold mb-0" style="font-size:0.9rem;">
                                                    ${item.nama_produk}${wholesaleBadge}
                                                </p>
                                                ${priceDisplay}
                                            </div>
                                            <div class="qty-controls">
                                                <button class="qty-btn" data-index="${index}" data-change="-1">-</button>
                                                <input type="number" class="qty-input" value="${item.qty}" data-index="${index}" min="1">
                                                <button class="qty-btn" data-index="${index}" data-change="1">+</button>
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger ms-2" data-index="${index}">
                                                <i class="bi bi-trash3" style="font-size: 16px;"></i>
                                            </button>
                                        </div>`;
                            }).join("") :
                            '<p class="text-center text-muted p-4">Keranjang kosong.</p>';

                        this.elements.cartBody.innerHTML = `${grosirNotificationsCart}${cartHtml}`;

                        this.elements.cartFooter.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center fw-bold fs-5 mb-2">
                                    <span>Total</span>
                                    <span>${_helpers.formatCurrency(cartData.finalTotal, true)}</span>
                                </div>
                                <button class="btn btn-primary w-100 fw-bold checkout-btn" 
                                        ${_state.katalogCart.length === 0 ? "disabled" : ""}>
                                    Checkout
                                </button>`;

                        // Attach event listeners to cart elements
                        this.attachCartEventListeners();
                    } catch (error) {
                        console.error("Error rendering cart items:", error);
                        this.elements.cartBody.innerHTML = '<p class="text-center text-danger p-4">Gagal memuat keranjang</p>';
                    }
                },

                attachCartEventListeners() {
                    // Quantity buttons
                    this.elements.cartBody.querySelectorAll('.qty-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                            const change = parseInt(e.currentTarget.getAttribute('data-change'), 10);

                            _state.katalogCart[index].qty = Math.max(1, _state.katalogCart[index].qty + change);
                            this.saveCart();
                            this.renderCartItems();
                        });
                    });

                    // Quantity inputs
                    this.elements.cartBody.querySelectorAll('.qty-input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                            const newQty = Math.max(1, parseInt(e.currentTarget.value, 10) || 1);

                            _state.katalogCart[index].qty = newQty;
                            this.saveCart();
                            this.renderCartItems();
                        });
                    });

                    // Delete buttons
                    this.elements.cartBody.querySelectorAll('.btn-outline-danger').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                            _state.katalogCart.splice(index, 1);
                            this.saveCart();
                            this.updateCartCount();
                            this.renderCartItems();
                        });
                    });

                    // Checkout button
                    const checkoutBtn = this.elements.cartFooter.querySelector('.checkout-btn');
                    if (checkoutBtn) {
                        checkoutBtn.addEventListener('click', () => {
                            this.toggleCart(false);
                            setTimeout(() => this.showCheckoutModal(), 350);
                        });
                    }
                },

                showCheckoutModal() {
                    const modalContentEl = document.getElementById("katalog-checkout-modal-content");
                    if (!modalContentEl) return;

                    try {
                        const cartData = this._calculateFinalCart();
                        const isWholesaleOrder = cartData.items.some(item => item.wholesaleApplied);
                        const shippingCost = isWholesaleOrder ? 0 : _config.FLAT_SHIPPING_RATE;
                        const grandTotal = cartData.finalTotal + shippingCost;

                        const shippingCostHTML = isWholesaleOrder ?
                            `<span class="fw-bold text-success">Gratis (Promo Grosir)</span>` :
                            `<span class="fw-bold">${_helpers.formatCurrency(shippingCost, true)}</span>`;

                        const codOptionHTML = _config.COD_ENABLED ? `
                                <div class="form-check border rounded p-3">
                                    <input class="form-check-input" type="radio" name="payment-method" id="pay-cod" value="COD">
                                    <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="pay-cod">
                                        <div>
                                            <span class="fw-semibold">Bayar di Tempat (COD)</span><br>
                                            <small class="text-muted">Siapkan uang pas saat kurir tiba.</small>
                                        </div>
                                        <i class="bi bi-cash-coin fs-4 text-success"></i>
                                    </label>
                                </div>
                            ` : "";

                        modalContentEl.innerHTML = `
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold">Checkout Pesanan</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <h6 class="fw-semibold">Ringkasan Pesanan</h6>
                                    <div class="bg-light p-3 rounded mb-4">
                                        <div class="d-flex justify-content-between">
                                            <span>Subtotal Belanja</span>
                                            <span class="fw-bold">${_helpers.formatCurrency(cartData.finalTotal, true)}</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Ongkos Kirim</span>
                                            ${shippingCostHTML}
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold fs-5">
                                            <span>Total Pembayaran</span>
                                            <span>${_helpers.formatCurrency(grandTotal, true)}</span>
                                        </div>
                                    </div>

                                    <h6 class="fw-semibold">1. Data Pemesan</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Nama Lengkap*</label>
                                        <input type="text" id="customer-name" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">No. WhatsApp*</label>
                                        <input type="tel" id="customer-phone" class="form-control" placeholder="Contoh: 08123456789" required>
                                    </div>
                                    
                                    <h6 class="fw-semibold mt-4">2. Alamat Pengiriman</h6>
                                    <div class="mb-3">
                                        <label for="customer-province" class="form-label">Provinsi*</label>
                                        <select id="customer-province" class="form-select" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer-regency" class="form-label">Kabupaten/Kota*</label>
                                        <select id="customer-regency" class="form-select" disabled required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer-district" class="form-label">Kecamatan*</label>
                                        <select id="customer-district" class="form-select" disabled required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer-street" class="form-label">Alamat Lengkap*</label>
                                        <textarea id="customer-street" class="form-control" rows="2" placeholder="Nama jalan, nama gedung, nomor rumah, desa/kelurahan..." required></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-6 col-sm-4">
                                            <div class="mb-3">
                                                <label for="customer-rt" class="form-label">RT</label>
                                                <input type="text" id="customer-rt" class="form-control" placeholder="001">
                                            </div>
                                        </div>
                                        <div class="col-6 col-sm-4">
                                            <div class="mb-3">
                                                <label for="customer-rw" class="form-label">RW</label>
                                                <input type="text" id="customer-rw" class="form-control" placeholder="002">
                                            </div>
                                        </div>
                                        <div class="col-12 col-sm-4">
                                            <div class="mb-3">
                                                <label for="customer-postalcode" class="form-label">Kode Pos</label>
                                                <input type="text" id="customer-postalcode" class="form-control" placeholder="53412">
                                            </div>
                                        </div>
                                    </div>

                                    <h6 class="fw-semibold mt-4">3. Metode Pembayaran</h6>
                                    <div class="form-check border rounded p-3 mb-2">
                                        <input class="form-check-input" type="radio" name="payment-method" id="pay-bri" value="BRI" checked>
                                        <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="pay-bri">
                                            <div>
                                                <span class="fw-semibold">Transfer Bank BRI</span><br>
                                                <small class="text-muted">No. Rek: 661901000007560 (a/n Suyoko)</small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="MDRApp.copyToClipboard('661901000007560')">
                                                <i class="bi bi-copy" style="font-size:12px;"></i>
                                            </button>
                                        </label>
                                    </div>
                                    <div class="form-check border rounded p-3 mb-2">
                                        <input class="form-check-input" type="radio" name="payment-method" id="pay-bca" value="BCA">
                                        <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="pay-bca">
                                            <div>
                                                <span class="fw-semibold">Transfer Bank BCA</span><br>
                                                <small class="text-muted">No. Rek: 3570513264 (a/n Suyoko)</small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="MDRApp.copyToClipboard('3570513264')">
                                                <i class="bi bi-copy" style="font-size:12px;"></i>
                                            </button>
                                        </label>
                                    </div>
                                    ${codOptionHTML}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                    <button type="button" class="btn btn-primary w-50" id="confirm-checkout-btn">Konfirmasi via WhatsApp</button>
                                </div>`;

                        // Initialize region dropdowns
                        _regionModule.initProvinces();

                        // Register event listeners for region dropdowns
                        const provinceSelect = document.getElementById("customer-province");
                        if (provinceSelect) {
                            _uiModule.registerModalListener(
                                "katalog-checkout-modal",
                                provinceSelect,
                                "change",
                                (e) => _regionModule.onProvinceChange(e.target.value)
                            );
                        }

                        const regencySelect = document.getElementById("customer-regency");
                        if (regencySelect) {
                            _uiModule.registerModalListener(
                                "katalog-checkout-modal",
                                regencySelect,
                                "change",
                                (e) => _regionModule.onRegencyChange(e.target.value)
                            );
                        }

                        // Register checkout button listener
                        const confirmBtn = document.getElementById("confirm-checkout-btn");
                        if (confirmBtn) {
                            _uiModule.registerModalListener(
                                "katalog-checkout-modal",
                                confirmBtn,
                                "click",
                                () => this.handleCheckoutSubmit()
                            );
                        }

                        _uiModule.showModal("katalog-checkout-modal");
                    } catch (error) {
                        console.error("Error showing checkout modal:", error);
                        _helpers.showError("Gagal memuat halaman checkout");
                    }
                },

                handleCheckoutSubmit() {
                    // Helper to get selected text from a dropdown
                    const getSelectedText = (el) => {
                        if (!el || !el.options) return "";
                        return el.options[el.selectedIndex]?.text || "";
                    };

                    // Helper to get value from element, with fallback for fallback inputs
                    const getElementValue = (id) => {
                        const el = document.getElementById(id);
                        if (!el) return "";

                        // Check if it's a fallback input
                        if (el.id.includes('-fallback')) {
                            return el.value.trim();
                        }

                        return getSelectedText(el);
                    };

                    const provinceEl = document.getElementById("customer-province") ||
                        document.getElementById("customer-province-fallback");
                    const regencyEl = document.getElementById("customer-regency") ||
                        document.getElementById("customer-regency-fallback");
                    const districtEl = document.getElementById("customer-district") ||
                        document.getElementById("customer-district-fallback");

                    const customerData = {
                        name: document.getElementById("customer-name")?.value.trim() || "",
                        phone: document.getElementById("customer-phone")?.value.trim() || "",
                        province: getElementValue("customer-province"),
                        regency: getElementValue("customer-regency"),
                        district: getElementValue("customer-district"),
                        street: document.getElementById("customer-street")?.value.trim() || "",
                        rt: document.getElementById("customer-rt")?.value.trim() || "",
                        rw: document.getElementById("customer-rw")?.value.trim() || "",
                        postalCode: document.getElementById("customer-postalcode")?.value.trim() || ""
                    };

                    // Validation
                    const errors = [];
                    if (!customerData.name) errors.push("Nama lengkap");
                    if (!customerData.phone) errors.push("Nomor WhatsApp");
                    if (!customerData.province) errors.push("Provinsi");
                    if (!customerData.regency) errors.push("Kabupaten/Kota");
                    if (!customerData.district) errors.push("Kecamatan");
                    if (!customerData.street) errors.push("Alamat lengkap");

                    if (!_helpers.validatePhone(customerData.phone)) {
                        errors.push("Format nomor WhatsApp tidak valid");
                    }

                    if (errors.length > 0) {
                        return Swal.fire(
                            "Data Tidak Lengkap",
                            `Harap lengkapi: ${errors.join(", ")}`,
                            "warning"
                        );
                    }

                    // Construct full address string
                    let fullAddress = `${customerData.street}`;
                    if (customerData.rt || customerData.rw) {
                        fullAddress += `, RT ${customerData.rt || "-"} / RW ${customerData.rw || "-"}`;
                    }
                    fullAddress += `\nKec. ${customerData.district}, ${customerData.regency}\n${customerData.province}`;
                    if (customerData.postalCode) {
                        fullAddress += `, ${customerData.postalCode}`;
                    }

                    customerData.fullAddress = fullAddress;

                    const selectedRadio = document.querySelector('input[name="payment-method"]:checked');
                    if (!selectedRadio) {
                        return Swal.fire(
                            "Pilih Metode Pembayaran",
                            "Harap pilih metode pembayaran terlebih dahulu.",
                            "warning"
                        );
                    }

                    const paymentMethod = selectedRadio.value;
                    let paymentDetails = "";
                    let paymentMessage = "";

                    if (paymentMethod === "COD") {
                        paymentDetails = "Bayar di Tempat (COD)";
                        paymentMessage = `METODE PEMBAYARAN: ${paymentDetails}`;
                    } else {
                        paymentDetails = selectedRadio.closest(".form-check")?.querySelector("small")?.textContent || "";
                        paymentMessage = `PEMBAYARAN VIA: ${paymentMethod}\n${paymentDetails}`;
                    }

                    const cartData = this._calculateFinalCart();
                    const isWholesaleOrder = cartData.items.some(item => item.wholesaleApplied);
                    const shippingCost = isWholesaleOrder ? 0 : _config.FLAT_SHIPPING_RATE;
                    const grandTotal = cartData.finalTotal + shippingCost;

                    // Create history entry
                    const historyEntry = {
                        id: `MDR-${new Date().getTime()}`,
                        date: new Date().toISOString(),
                        items: cartData.items,
                        total: grandTotal,
                        customer: customerData,
                        payment: {
                            bank: paymentMethod,
                            details: paymentDetails
                        },
                        shipping: shippingCost
                    };

                    _state.katalogHistory.unshift(historyEntry);
                    this.saveHistory();

                    // Kirim data ke Google Sheets
                    try {
                        const sheetPayload = {
                            action: 'logTransaction',
                            customer: historyEntry.customer,
                            items: historyEntry.items,
                            total: historyEntry.total
                        };

                        // PERBAIKAN: Gunakan _config.API_BASE_URL
                        fetch(_config.API_BASE_URL, {
                            method: 'POST',
                            body: JSON.stringify(sheetPayload),
                            headers: { 'Content-Type': 'application/json' }
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    console.log('Riwayat pesanan berhasil disimpan ke spreadsheet.');
                                } else {
                                    console.error('Gagal menyimpan riwayat ke spreadsheet:', data.message);
                                }
                            })
                            .catch(err => console.error('Error saat mengirim riwayat ke spreadsheet:', err));

                    } catch (e) {
                        console.error('Error membuat payload untuk spreadsheet:', e);
                    }

                    // Group items by category for better readability
                    const groupedItems = cartData.items.reduce((acc, item) => {
                        const category = (item.nama_kategori || "Lainnya").toUpperCase();
                        if (!acc[category]) acc[category] = [];
                        acc[category].push(item);
                        return acc;
                    }, {});

                    let detailPesanan = Object.entries(groupedItems)
                        .map(([category, items]) =>
                            `${category}\n${items
                                .map((item, i) =>
                                    `${i + 1}. ${item.nama_produk}\n    Kode: ${item.kode_produk || "-"}\n    Jumlah: ${item.qty} pcs\n    Harga: ${_helpers.formatCurrency(item.finalPrice, true)}`
                                )
                                .join("\n\n")}`
                        )
                        .join("\n\n");

                    const message = `PESANAN BARU - MDR STORE\n=========================\n\nNO. INVOICE: ${historyEntry.id}\n\nDATA PELANGGAN\n- Nama: ${customerData.name}\n- WhatsApp: ${customerData.phone}\n\nALAMAT PENGIRIMAN\n${customerData.fullAddress}\n\nDETAIL PESANAN\n${detailPesanan}\n\n${paymentMessage}\n\nRINCIAN PEMBAYARAN\n- Subtotal Belanja: ${_helpers.formatCurrency(cartData.finalTotal, true)}\n- Ongkos Kirim: ${isWholesaleOrder ? "Gratis" : _helpers.formatCurrency(shippingCost, true)}\n- TOTAL PEMBAYARAN: ${_helpers.formatCurrency(grandTotal, true)}\n\nTerima kasih,\n${customerData.name}`;

                    // Open WhatsApp
                    window.open(
                        `https://wa.me/6288988444888?text=${encodeURIComponent(message)}`,
                        "_blank"
                    );

                    // Clear cart and update UI
                    _state.katalogCart = [];
                    this.saveCart();
                    this.updateCartCount();
                    _uiModule.hideModal("katalog-checkout-modal");

                    Swal.fire({
                        icon: "success",
                        title: "Pesanan Dikirim!",
                        text: "Pesanan telah dikirim via WhatsApp. Admin akan segera menghubungi Anda.",
                        confirmButtonText: "Mengerti"
                    });
                },

                saveCart() {
                    try {
                        localStorage.setItem("katalogCart", JSON.stringify(_state.katalogCart));
                    } catch (error) {
                        console.error("Error saving cart:", error);
                    }
                },

                loadHistory() {
                    try {
                        _state.katalogHistory = JSON.parse(localStorage.getItem("katalogHistory")) || [];
                    } catch (error) {
                        console.error("Error loading history:", error);
                        _state.katalogHistory = [];
                    }
                },

                saveHistory() {
                    try {
                        localStorage.setItem("katalogHistory", JSON.stringify(_state.katalogHistory));
                    } catch (error) {
                        console.error("Error saving history:", error);
                    }
                },

                showHistoryModal() {
                    const modalContentEl = document.getElementById("katalog-history-modal-content");
                    if (!modalContentEl) return;

                    try {
                        const historyHtml = _state.katalogHistory.length > 0 ?
                            _state.katalogHistory.map(trx => {
                                const date = new Date(trx.date)
                                    .toLocaleString("id-ID", {
                                        dateStyle: "medium",
                                        timeStyle: "short"
                                    })
                                    .replace(/\./g, ":");

                                const itemsHtml = trx.items
                                    .map(item =>
                                        `<div class="d-flex justify-content-between">
                                                <span class="text-truncate" style="max-width: 70%;">${item.nama_produk} (x${item.qty})</span>
                                                <span>${_helpers.formatCurrency(item.finalPrice * item.qty, true)}</span>
                                            </div>`
                                    )
                                    .join("");

                                return `
                                        <div class="history-item">
                                            <div class="history-item-header d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong class="d-block">${trx.id}</strong>
                                                    <small class="text-muted">${date}</small>
                                                </div>
                                            </div>
                                            <div class="history-item-body">${itemsHtml}</div>
                                            <div class="history-item-footer text-end">
                                                <strong>Total: ${_helpers.formatCurrency(trx.total, true)}</strong>
                                            </div>
                                        </div>`;
                            }).join("") :
                            '<p class="text-center text-muted p-5">Belum ada riwayat transaksi.</p>';

                        modalContentEl.innerHTML = `
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold">Riwayat Transaksi</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">${historyHtml}</div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline-danger" onclick="MDRApp.clearHistory()" 
                                            ${_state.katalogHistory.length === 0 ? "disabled" : ""}>
                                        Hapus Semua Riwayat
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                                </div>`;

                        _uiModule.showModal("katalog-history-modal");
                    } catch (error) {
                        console.error("Error showing history modal:", error);
                        modalContentEl.innerHTML = `
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold">Riwayat Transaksi</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-center text-danger p-5">Gagal memuat riwayat transaksi.</p>
                                </div>`;
                    }
                },

                clearHistory() {
                    Swal.fire({
                        title: "Anda yakin?",
                        text: "Semua riwayat transaksi akan dihapus permanen!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#d33",
                        cancelButtonColor: "#6c757d",
                        confirmButtonText: "Ya, hapus!",
                        cancelButtonText: "Batal"
                    }).then(result => {
                        if (result.isConfirmed) {
                            _state.katalogHistory = [];
                            this.saveHistory();
                            this.showHistoryModal();
                            Swal.fire(
                                "Terhapus!",
                                "Riwayat transaksi Anda telah dihapus.",
                                "success"
                            );
                        }
                    });
                }
            };

            // Maintenance Checker Module
            const _maintenanceCheckerModule = {
                init() {
                    this.checkMaintenanceTime();
                },

                checkMaintenanceTime() {
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();

                    if ((currentHour === 23 && currentMinute >= 30) || (currentHour === 0 && currentMinute < 30)) {
                        Swal.fire({
                            title: "Informasi Maintenance",
                            html: "Setiap hari pada pukul <b>23:30 - 00:30 WIB</b> kami melakukan maintenance rutin. <br>Transaksi mungkin akan mengalami keterlambatan. Mohon maklum.",
                            icon: "info",
                            iconColor: "#008ca7",
                            confirmButtonText: "Mengerti",
                            customClass: {
                                popup: "rounded-3",
                                confirmButton: "btn btn-primary"
                            },
                            buttonsStyling: false
                        });
                    }
                }
            };

            // Public API
            return {
                init: function () {
                    document.addEventListener("DOMContentLoaded", () => {
                        console.log("MDR App Initializing...");

                        try {
                            _uiModule.init();
                            _greetingModule.init();
                            _maintenanceCheckerModule.init();
                            _katalogModule.init();

                            console.log("MDR App Initialized Successfully");
                        } catch (error) {
                            console.error("Error during MDR App initialization:", error);
                            _helpers.showError(
                                "Terjadi kesalahan saat memuat aplikasi. Silakan refresh halaman.",
                                "Kesalahan Inisialisasi"
                            );
                        }
                    });
                },

                removeFilter: function (filterType) {
                    const filterEl = _katalogModule.elements[`${filterType}Filter`];
                    if (filterEl) {
                        filterEl.value = "all";
                        _katalogModule.filterAndRender();
                    }
                },

                copyToClipboard: function (text) {
                    const showSuccess = () => Swal.fire({
                        toast: true,
                        position: "top-end",
                        icon: "success",
                        title: "Nomor rekening disalin!",
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    const showManualCopyPrompt = () => Swal.fire({
                        title: "Gagal Menyalin",
                        html: `<p class="text-start mb-2">Salin manual:</p>
                                  <div class="input-group">
                                      <input type="text" value="${text}" class="form-control text-center fw-bold" readonly id="manual-copy-input">
                                      <button class="btn btn-outline-secondary" onclick="document.getElementById('manual-copy-input').select(); document.execCommand('copy');">
                                          <i class="bi bi-copy"></i>
                                      </button>
                                  </div>`,
                        icon: "warning",
                        confirmButtonText: "Tutup"
                    });

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text)
                            .then(showSuccess)
                            .catch(showManualCopyPrompt);
                    } else {
                        showManualCopyPrompt();
                    }
                },

                clearHistory: _katalogModule.clearHistory.bind(_katalogModule),

                refreshKatalog: function () {
                    _katalogModule.fetchAndUpdateProducts();
                },

                // PERUBAHAN PENTING: Tambahkan fungsi force refresh
                forceRefreshKatalog: function() {
                    console.log("Force refreshing katalog data...");
                    
                    // Clear all related cache
                    localStorage.removeItem("katalogProductsCache");
                    localStorage.removeItem("katalogLastUpdate");
                    
                    // Reset state
                    _state.katalogProducts = [];
                    
                    // Fetch fresh data
                    _katalogModule.fetchAndUpdateProducts();
                    
                    Swal.fire({
                        title: "Memuat Data Baru",
                        text: "Sedang mengambil data terbaru dari server...",
                        icon: "info",
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });
                },

                // Expose for debugging
                _state: _state,
                _config: _config
            };
        })();

        // Initialize the application
        MDRApp.init();
    </script>
</body>

</html>
