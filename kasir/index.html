<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDR Kasir Pro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #008ca7;
            --primary-light: #4cb8cc;
            --primary-dark: #006983;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --bs-body-bg: #f0f2f5;
            --bs-body-color: #212529;
            --bs-secondary-bg: #ffffff;
            --bs-tertiary-bg: #f8f9fa;
        }

        [data-bs-theme="dark"] {
            --primary-color: #0097b2;
            --primary-light: #4ac7e0;
            --primary-dark: #007a8f;
            --glass-bg: rgba(33, 37, 41, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --bs-body-bg: #1a1a1a;
            --bs-body-color: #dee2e6;
            --bs-secondary-bg: #212529;
            --bs-tertiary-bg: #2c3034;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            min-height: 100vh;
            padding-bottom: 2rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
            overflow: hidden;
        }
        
        .card-product {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bs-secondary-bg);
        }
        
        .card-product:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15) !important;
        }
        
        .nav-tabs {
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-tabs .nav-link {
            color: #6c757d;
            border-radius: 12px 12px 0 0;
            border: none;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        
        [data-bs-theme="dark"] .nav-tabs .nav-link {
            color: #adb5bd;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: rgba(0, 140, 167, 0.05);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--bs-tertiary-bg);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .kas-card i {
            font-size: 2.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        [data-bs-theme="dark"] .btn-outline-primary:hover {
            color: #212529;
        }
        
        .text-primary {
            color: var(--primary-color) !important;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 140, 167, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .header-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
        }
    </style>
</head>
<body>

    <div class="container py-4">

        <!-- Header -->
        <header class="header-gradient mb-4 text-center">
            <h1 class="display-5 fw-bold" id="store-name-header">MDR Kasir Pro</h1>
            <p class="mb-0 opacity-75">Kelola Penjualan, Piutang, dan Kas untuk Toko Anda.</p>
        </header>
        
        <!-- Saldo Kas -->
        <div class="saldo-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="saldo-title mb-0">Saldo Kas</h4>
                <button id="ubah-saldo-btn" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil-square me-1"></i> Ubah Saldo
                </button>
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card glass-card kas-card">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-cash-coin text-success me-3"></i>
                            <div>
                                <h6 class="card-subtitle text-muted">Kas Tunai</h6>
                                <p id="kas-tunai" class="card-title fs-4 fw-bold mb-0">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card glass-card kas-card">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-bank2 text-primary me-3"></i>
                            <div>
                                <h6 class="card-subtitle text-muted">Kas Bank</h6>
                                <p id="kas-bank" class="card-title fs-4 fw-bold mb-0">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card glass-card kas-card">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-wallet2 text-warning me-3"></i>
                            <div>
                                <h6 class="card-subtitle text-muted">Kas E-Wallet</h6>
                                <p id="kas-ewallet" class="card-title fs-4 fw-bold mb-0">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-0" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-kasir" data-bs-toggle="tab" data-bs-target="#view-kasir" type="button" role="tab"><i class="bi bi-cart3 me-1"></i>Kasir</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-produk" data-bs-toggle="tab" data-bs-target="#view-produk" type="button" role="tab"><i class="bi bi-box-seam me-1"></i>Manajemen Produk</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-laporan" data-bs-toggle="tab" data-bs-target="#view-laporan" type="button" role="tab"><i class="bi bi-graph-up me-1"></i>Laporan</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-pengaturan" data-bs-toggle="tab" data-bs-target="#view-pengaturan" type="button" role="tab"><i class="bi bi-gear me-1"></i>Pengaturan</button>
            </li>
        </ul>

        <!-- Main Content -->
        <main class="tab-content">
            <!-- Kasir View -->
            <div class="tab-pane fade show active" id="view-kasir" role="tabpanel">
                 <div class="card glass-card rounded-top-0">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-7">
                                <h4 class="card-title mb-3">Pilih Produk</h4>
                                <input type="text" id="search-product" placeholder="Cari nama produk..." class="form-control search-box mb-3">
                                <div id="product-list-kasir" class="product-grid row row-cols-2 row-cols-md-3 g-3">
                                    <!-- Daftar produk akan ditampilkan di sini -->
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <div class="card h-100 bg-body-tertiary">
                                    <div class="card-body d-flex flex-column">
                                        <h4 class="card-title mb-3">Keranjang</h4>
                                        <div id="cart-items" class="flex-grow-1" style="min-height: 200px; overflow-y: auto;">
                                            <div id="cart-empty" class="text-center text-muted d-flex align-items-center justify-content-center h-100">
                                                <p>Keranjang kosong</p>
                                            </div>
                                        </div>
                                        <div class="border-top pt-3 mt-3">
                                            <div class="d-flex justify-content-between align-items-center fw-bold fs-5 mb-3">
                                                <span>Total:</span>
                                                <span id="cart-total">Rp 0</span>
                                            </div>
                                            <div class="mb-2">
                                                <label for="customer-name" class="form-label small">Nama Pelanggan</label>
                                                <input type="text" id="customer-name" class="form-control form-control-sm" value="Umum">
                                            </div>
                                            <div class="mb-2">
                                                <label for="payment-method" class="form-label small">Metode Pembayaran</label>
                                                <select id="payment-method" class="form-select form-select-sm">
                                                    <option value="Tunai">Tunai</option>
                                                    <option value="Transfer">Transfer</option>
                                                    <option value="Hutang">Hutang</option>
                                                    <option value="Bayar Sebagian">Bayar Sebagian</option>
                                                </select>
                                            </div>
                                            <div id="amount-paid-group" class="mb-2 d-none">
                                                <label for="amount-paid" class="form-label small">Jumlah Dibayar</label>
                                                <input type="number" id="amount-paid" class="form-control form-control-sm" placeholder="0">
                                            </div>
                                            <div id="kas-tujuan-group" class="mb-3">
                                                <label for="kas-tujuan" class="form-label small">Masuk Ke Kas</label>
                                                <select id="kas-tujuan" class="form-select form-select-sm">
                                                    <option value="Tunai">Tunai</option>
                                                    <option value="Bank">Bank</option>
                                                    <option value="E-Wallet">E-Wallet</option>
                                                </select>
                                            </div>
                                            <button id="process-transaction-btn" class="btn btn-primary w-100 mb-2" disabled>
                                                <i class="bi bi-check2-circle me-1"></i> Proses Transaksi
                                            </button>
                                            <button id="clear-cart-btn" class="btn btn-outline-danger w-100">
                                                <i class="bi bi-trash3 me-1"></i> Kosongkan Keranjang
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Produk View -->
            <div class="tab-pane fade" id="view-produk" role="tabpanel">
                 <div class="card glass-card rounded-top-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="card-title mb-0">Daftar Produk</h4>
                            <button id="add-product-btn" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Tambah Produk</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nama Produk</th>
                                        <th>Harga Beli</th>
                                        <th>Harga Jual</th>
                                        <th>Keuntungan</th>
                                        <th class="text-end">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="product-list-manajemen"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Laporan View -->
            <div class="tab-pane fade" id="view-laporan" role="tabpanel">
                <div class="card glass-card rounded-top-0">
                    <div class="card-body">
                         <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3">
                            <h4 class="card-title mb-2 mb-md-0">Riwayat Transaksi</h4>
                            <div class="btn-group" role="group">
                                <button type="button" data-filter="all" class="filter-btn btn btn-sm btn-outline-primary active">Semua</button>
                                <button type="button" data-filter="lunas" class="filter-btn btn btn-sm btn-outline-primary">Lunas</button>
                                <button type="button" data-filter="hutang" class="filter-btn btn btn-sm btn-outline-primary">Berhutang</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Pelanggan</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th class="text-end">Detail</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pengaturan View -->
            <div class="tab-pane fade" id="view-pengaturan" role="tabpanel">
                <div class="card glass-card rounded-top-0">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <h5 class="card-title mb-3">Informasi Toko & Struk</h5>
                                <form id="settings-form">
                                    <div class="mb-3">
                                        <label for="setting-store-name" class="form-label">Nama Toko</label>
                                        <input type="text" class="form-control" id="setting-store-name">
                                    </div>
                                    <div class="mb-3">
                                        <label for="setting-store-contact" class="form-label">Alamat / Kontak</label>
                                        <input type="text" class="form-control" id="setting-store-contact" placeholder="cth: Jl. Merdeka No. 1 / 0812345678">
                                    </div>
                                    <div class="mb-3">
                                        <label for="setting-receipt-message" class="form-label">Pesan di Struk</label>
                                        <textarea class="form-control" id="setting-receipt-message" rows="2"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                </form>
                            </div>
                            <div class="col-lg-6">
                                <div class="mb-4">
                                    <h5 class="card-title mb-3">Tampilan</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle">
                                        <label class="form-check-label" for="dark-mode-toggle">Mode Gelap</label>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="card-title mb-3">Manajemen Data</h5>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" id="export-data-btn"><i class="bi bi-box-arrow-down me-2"></i>Ekspor Data (JSON)</button>
                                        <button class="btn btn-outline-primary" id="import-data-btn"><i class="bi bi-box-arrow-up me-2"></i>Impor Data (JSON)</button>
                                        <input type="file" id="import-file-input" class="d-none" accept=".json">
                                        <button class="btn btn-outline-danger mt-3" id="reset-data-btn"><i class="bi bi-exclamation-triangle me-2"></i>Reset Semua Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="product-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="product-modal-title">Tambah Produk Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="mb-3">
                            <label for="product-name" class="form-label">Nama Produk</label>
                            <input type="text" id="product-name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="purchase-price" class="form-label">Harga Beli</label>
                            <input type="number" id="purchase-price" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="selling-price" class="form-label">Harga Jual</label>
                            <input type="number" id="selling-price" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" form="product-form" class="btn btn-primary">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="receipt-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                 <div class="modal-header">
                    <h5 class="modal-title">Detail Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receipt-content-wrapper">
                    <!-- Konten detail transaksi akan ditampilkan di sini -->
                </div>
                <div class="modal-footer">
                    <button id="share-whatsapp-btn" class="btn btn-info text-white"><i class="bi bi-whatsapp me-1"></i>Bagikan</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="kas-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ubah Saldo Kas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="kas-form">
                        <div class="mb-3">
                            <label for="kas-tunai-input" class="form-label">Kas Tunai</label>
                            <input type="number" id="kas-tunai-input" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="kas-bank-input" class="form-label">Kas Bank</label>
                            <input type="number" id="kas-bank-input" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="kas-ewallet-input" class="form-label">Kas E-Wallet</label>
                            <input type="number" id="kas-ewallet-input" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" form="kas-form" class="btn btn-primary">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let products = [];
        let transactions = [];
        let cart = [];
        let kas = { 'Tunai': 0, 'Bank': 0, 'E-Wallet': 0 };
        let settings = {};
        const defaultSettings = {
            storeName: 'MDR Store',
            storeContact: '',
            receiptMessage: 'Terima kasih!',
            darkMode: false
        };
        
        // --- INSTANSIASI MODAL ---
        const productModal = new bootstrap.Modal(document.getElementById('product-modal'));
        const receiptModal = new bootstrap.Modal(document.getElementById('receipt-modal'));
        const kasModal = new bootstrap.Modal(document.getElementById('kas-modal'));

        // --- FUNGSI UTILITAS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

        // --- PENYIMPANAN DATA ---
        const saveData = () => {
            localStorage.setItem('kasir_products_pro', JSON.stringify(products));
            localStorage.setItem('kasir_transactions_pro', JSON.stringify(transactions));
            localStorage.setItem('kasir_kas_pro', JSON.stringify(kas));
            localStorage.setItem('kasir_settings_pro', JSON.stringify(settings));
        };
        
        const loadData = () => {
            products = JSON.parse(localStorage.getItem('kasir_products_pro')) || [];
            transactions = JSON.parse(localStorage.getItem('kasir_transactions_pro')) || [];
            kas = JSON.parse(localStorage.getItem('kasir_kas_pro')) || { 'Tunai': 0, 'Bank': 0, 'E-Wallet': 0 };
            settings = { ...defaultSettings, ...JSON.parse(localStorage.getItem('kasir_settings_pro')) };
        };

        // --- FUNGSI RENDER ---
        const renderAll = () => {
            renderKas();
            renderProductsKasir();
            renderProductsManajemen();
            renderCart();
            renderTransactions();
            renderSettings();
        };

        const renderKas = () => {
            document.getElementById('kas-tunai').textContent = formatCurrency(kas['Tunai']);
            document.getElementById('kas-bank').textContent = formatCurrency(kas['Bank']);
            document.getElementById('kas-ewallet').textContent = formatCurrency(kas['E-Wallet']);
        };
        
        const renderProductsKasir = () => {
            const list = document.getElementById('product-list-kasir');
            const searchTerm = document.getElementById('search-product').value.toLowerCase();
            list.innerHTML = '';
            const filteredProducts = products.filter(p => p.name.toLowerCase().includes(searchTerm));
            filteredProducts.forEach(product => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'col';
                cardWrapper.innerHTML = `
                    <div class="card h-100 text-center card-product shadow-sm">
                        <div class="card-body d-flex flex-column justify-content-center p-2">
                            <h6 class="card-title small text-truncate">${product.name}</h6>
                            <p class="card-text fw-bold text-primary mb-0">${formatCurrency(product.sellingPrice)}</p>
                        </div>
                    </div>`;
                cardWrapper.onclick = () => addToCart(product.id);
                list.appendChild(cardWrapper);
            });
        };
        
        const renderProductsManajemen = () => {
            const tbody = document.getElementById('product-list-manajemen');
            tbody.innerHTML = '';
            products.forEach(p => {
                const profit = p.sellingPrice - p.purchasePrice;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="fw-medium">${p.name}</td>
                    <td>${formatCurrency(p.purchasePrice)}</td>
                    <td>${formatCurrency(p.sellingPrice)}</td>
                    <td class="text-success">${formatCurrency(profit)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-warning edit-btn me-1" data-id="${p.id}"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${p.id}"><i class="bi bi-trash3"></i></button>
                    </td>`;
                tbody.appendChild(row);
            });
        };

        const renderCart = () => {
            const cartItemsEl = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const processBtn = document.getElementById('process-transaction-btn');
            let total = cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
            
            if (cart.length === 0) {
                cartItemsEl.innerHTML = `
                    <div id="cart-empty" class="text-center text-muted d-flex align-items-center justify-content-center h-100">
                        <p>Keranjang kosong</p>
                    </div>`;
                processBtn.disabled = true;
            } else {
                cartItemsEl.innerHTML = '';
                cart.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="small">
                                <p class="fw-medium mb-0">${item.name}</p>
                                <p class="text-muted mb-0">${formatCurrency(item.sellingPrice)} x ${item.quantity}</p>
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary quantity-btn quantity-change-btn me-1" data-id="${item.id}" data-change="-1">-</button>
                                <span class="mx-2 small">${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary quantity-btn quantity-change-btn me-2" data-id="${item.id}" data-change="1">+</button>
                                <button class="btn btn-sm btn-link text-danger py-0 px-1 remove-from-cart-btn" data-id="${item.id}"><i class="bi bi-x-lg"></i></button>
                            </div>
                        </div>`;
                    cartItemsEl.appendChild(itemEl);
                });
                processBtn.disabled = false;
            }
            cartTotalEl.textContent = formatCurrency(total);
        };
        
        const renderTransactions = () => {
             const list = document.getElementById('transaction-list');
             const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
             list.innerHTML = '';
             let filtered = transactions;
             if(activeFilter === 'lunas') {
                 filtered = transactions.filter(tx => tx.paymentStatus === 'Lunas');
             } else if (activeFilter === 'hutang') {
                 filtered = transactions.filter(tx => tx.paymentStatus !== 'Lunas');
             }
             filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
             filtered.forEach(tx => {
                const statusMap = {
                    'Lunas': { bg: 'success', text: 'Lunas' },
                    'Hutang': { bg: 'danger', text: 'Hutang' },
                    'Belum Lunas': { bg: 'warning', text: 'Belum Lunas' },
                };
                const status = statusMap[tx.paymentStatus];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dayjs(tx.timestamp).format('DD MMM YYYY')}</td>
                    <td>${tx.customerName}</td>
                    <td>${formatCurrency(tx.totalAmount)}</td>
                    <td><span class="badge bg-${status.bg}">${status.text}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary view-detail-btn" data-id="${tx.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>`;
                list.appendChild(row);
             });
        };
        
        const renderSettings = () => {
            document.getElementById('setting-store-name').value = settings.storeName;
            document.getElementById('setting-store-contact').value = settings.storeContact;
            document.getElementById('setting-receipt-message').value = settings.receiptMessage;
            document.getElementById('store-name-header').textContent = settings.storeName;
            document.getElementById('dark-mode-toggle').checked = settings.darkMode;
            applyTheme();
        };

        const applyTheme = () => {
            document.documentElement.dataset.bsTheme = settings.darkMode ? 'dark' : 'light';
        };

        const showReceiptModal = (txId) => {
            const tx = transactions.find(t => t.id === txId);
            if (!tx) return;

            const wrapper = document.getElementById('receipt-content-wrapper');
            let itemsHtml = tx.items.map(i => `<div class="d-flex justify-content-between small"><span>${i.name} (x${i.quantity})</span><span>${formatCurrency(i.quantity * i.sellingPrice)}</span></div>`).join('');
            let paymentHistoryHtml = tx.paymentHistory.map(h => `<div class="d-flex justify-content-between small text-muted"><span>${dayjs(h.date).format('DD MMM, HH:mm')} (${h.kas})</span><span>+ ${formatCurrency(h.amount)}</span></div>`).join('');
            
            let debtManagementHtml = '';
            if (tx.paymentStatus !== 'Lunas') {
                debtManagementHtml = `
                    <div class="mt-3 pt-3 border-top">
                        <h5>Pembayaran Hutang</h5>
                        <div class="input-group mb-2">
                            <input type="number" id="add-payment-amount" class="form-control" placeholder="Jumlah bayar">
                            <select id="add-payment-kas" class="form-select" style="max-width: 100px;">
                                <option value="Tunai">Tunai</option>
                                <option value="Bank">Bank</option>
                                <option value="E-Wallet">E-Wallet</option>
                            </select>
                        </div>
                        <button class="btn btn-sm btn-primary w-100" id="add-payment-btn" data-id="${tx.id}">Tambah Pembayaran</button>
                        <button class="btn btn-sm btn-success w-100 mt-2" id="mark-lunas-btn" data-id="${tx.id}">Tandai Lunas</button>
                    </div>`;
            }

            wrapper.innerHTML = `
                <p class="small text-muted mb-1">ID: #${tx.id.substring(tx.id.length - 6)} | ${dayjs(tx.timestamp).format('DD MMM YYYY, HH:mm')}</p>
                <p class="fw-bold mb-2">Pelanggan: ${tx.customerName}</p>
                <div class="border-top border-bottom py-2">${itemsHtml}</div>
                <div class="d-flex justify-content-between fw-bold pt-2"><span>TOTAL</span><span>${formatCurrency(tx.totalAmount)}</span></div>
                <div class="d-flex justify-content-between small"><span>Dibayar</span><span>${formatCurrency(tx.amountPaid)}</span></div>
                <div class="d-flex justify-content-between small text-danger"><span>Sisa</span><span>${formatCurrency(tx.remainingBalance)}</span></div>
                <div class="mt-2 small">${paymentHistoryHtml}</div>
                ${debtManagementHtml}
            `;
            document.getElementById('share-whatsapp-btn').dataset.id = tx.id;
            receiptModal.show();
        };

        // --- LOGIKA INTI ---
        const addToCart = (productId) => {
            const product = products.find(p => p.id === productId);
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) cartItem.quantity++;
            else cart.push({ ...product, quantity: 1 });
            renderCart();
        };

        const processTransaction = () => {
            if (cart.length === 0) return;

            const totalAmount = cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
            const method = document.getElementById('payment-method').value;
            let amountPaid = 0, paymentStatus = '', kasTujuan = null;
            
            if(method === 'Tunai' || method === 'Transfer') {
                amountPaid = totalAmount;
                paymentStatus = 'Lunas';
                kasTujuan = document.getElementById('kas-tujuan').value;
            } else if (method === 'Hutang') {
                amountPaid = 0;
                paymentStatus = 'Hutang';
            } else if (method === 'Bayar Sebagian') {
                amountPaid = parseFloat(document.getElementById('amount-paid').value) || 0;
                if (amountPaid >= totalAmount) {
                    amountPaid = totalAmount;
                    paymentStatus = 'Lunas';
                } else if (amountPaid > 0) {
                    paymentStatus = 'Belum Lunas';
                } else {
                    paymentStatus = 'Hutang';
                }
                kasTujuan = document.getElementById('kas-tujuan').value;
            }
            
            const newTransaction = {
                id: generateId(),
                timestamp: new Date().toISOString(),
                customerName: document.getElementById('customer-name').value || 'Umum',
                items: [...cart],
                totalAmount,
                totalProfit: cart.reduce((sum, item) => sum + ((item.sellingPrice - item.purchasePrice) * item.quantity), 0),
                paymentMethod: method,
                paymentStatus,
                amountPaid,
                remainingBalance: totalAmount - amountPaid,
                paymentHistory: [],
            };
            
            if (amountPaid > 0) {
                newTransaction.paymentHistory.push({ date: new Date().toISOString(), amount: amountPaid, kas: kasTujuan });
                kas[kasTujuan] += amountPaid;
            }

            transactions.push(newTransaction);
            cart = [];
            
            saveData();
            renderAll();
            document.getElementById('customer-name').value = 'Umum';
            document.getElementById('amount-paid').value = '';
        };
        
        const generateReceiptText = (tx, forWhatsApp = false) => {
            const separator = '--------------------------------';
            let text = forWhatsApp ? `*Struk Transaksi - ${settings.storeName}*\n\n` : `Struk Transaksi - ${settings.storeName}\n\n`;
            if (settings.storeContact) text += `${settings.storeContact}\n`;
            text += `${separator}\n`;
            text += `Waktu: ${dayjs(tx.timestamp).format('DD MMM YYYY, HH:mm')}\n`;
            text += `Pelanggan: ${tx.customerName}\n${separator}\n`;
            tx.items.forEach(item => {
                text += `${item.name}\n${item.quantity} x ${formatCurrency(item.sellingPrice)} = ${formatCurrency(item.quantity * item.sellingPrice)}\n`;
            });
            text += `${separator}\n`;
            const totalText = `TOTAL: ${formatCurrency(tx.totalAmount)}`;
            const paidText = `DIBAYAR: ${formatCurrency(tx.amountPaid)}`;
            const dueText = `SISA: ${formatCurrency(tx.remainingBalance)}`;
            text += forWhatsApp ? `*${totalText}*\n` : `${totalText}\n`;
            text += `${paidText}\n`;
            text += forWhatsApp ? `*${dueText}*\n\n` : `${dueText}\n\n`;
            if (tx.paymentStatus !== 'Lunas') {
                 text += `Status: BELUM LUNAS\n\n`;
            }
            text += `${settings.receiptMessage}`;
            return text;
        };


        // --- EVENT LISTENERS ---
        document.getElementById('settings-form').addEventListener('submit', e => {
            e.preventDefault();
            settings.storeName = document.getElementById('setting-store-name').value;
            settings.storeContact = document.getElementById('setting-store-contact').value;
            settings.receiptMessage = document.getElementById('setting-receipt-message').value;
            saveData();
            renderSettings();
            alert('Pengaturan berhasil disimpan!');
        });

        document.getElementById('dark-mode-toggle').addEventListener('change', e => {
            settings.darkMode = e.target.checked;
            saveData();
            applyTheme();
        });

        document.getElementById('export-data-btn').addEventListener('click', () => {
            const dataToExport = { products, transactions, kas, settings };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mdr_kasir_backup_${dayjs().format('YYYYMMDD')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-data-btn').addEventListener('click', () => {
            document.getElementById('import-file-input').click();
        });

        document.getElementById('import-file-input').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (confirm('Anda yakin ingin menimpa semua data saat ini dengan data dari file?')) {
                        products = importedData.products || [];
                        transactions = importedData.transactions || [];
                        kas = importedData.kas || { 'Tunai': 0, 'Bank': 0, 'E-Wallet': 0 };
                        settings = { ...defaultSettings, ...importedData.settings };
                        saveData();
                        renderAll();
                        alert('Data berhasil diimpor!');
                    }
                } catch (error) {
                    alert('Gagal mengimpor data. File tidak valid.');
                    console.error(error);
                } finally {
                    e.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('reset-data-btn').addEventListener('click', () => {
            if (confirm('PERINGATAN! Tindakan ini akan menghapus semua data produk, transaksi, dan kas. Anda yakin ingin melanjutkan?')) {
                if(confirm('SEKALI LAGI, SEMUA DATA AKAN HILANG PERMANEN. Lanjutkan?')) {
                    localStorage.removeItem('kasir_products_pro');
                    localStorage.removeItem('kasir_transactions_pro');
                    localStorage.removeItem('kasir_kas_pro');
                    localStorage.removeItem('kasir_settings_pro');
                    location.reload();
                }
            }
        });
        
        document.getElementById('payment-method').addEventListener('change', e => {
            const method = e.target.value;
            document.getElementById('amount-paid-group').classList.toggle('d-none', method !== 'Bayar Sebagian');
            document.getElementById('kas-tujuan-group').classList.toggle('d-none', method === 'Hutang');
        });

        document.getElementById('process-transaction-btn').addEventListener('click', processTransaction);
        
        document.getElementById('add-product-btn').addEventListener('click', () => {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-modal-title').textContent = 'Tambah Produk Baru';
            productModal.show();
        });

        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const newProduct = {
                id: id || generateId(),
                name: document.getElementById('product-name').value,
                purchasePrice: parseFloat(document.getElementById('purchase-price').value),
                sellingPrice: parseFloat(document.getElementById('selling-price').value),
            };
            if (id) {
                products = products.map(p => p.id === id ? newProduct : p);
            } else {
                products.push(newProduct);
            }
            saveData();
            renderAll();
            productModal.hide();
            e.target.reset();
        });
        
        document.getElementById('search-product').addEventListener('input', renderProductsKasir);
        
        document.getElementById('clear-cart-btn').addEventListener('click', () => { 
            if (cart.length > 0) { 
                cart = []; 
                renderCart(); 
            }
        });

        document.getElementById('cart-items').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const productId = target.dataset.id;
            if (target.classList.contains('quantity-change-btn')) {
                const cartItem = cart.find(item => item.id === productId);
                if (cartItem) {
                    cartItem.quantity += parseInt(target.dataset.change);
                    if (cartItem.quantity <= 0) cart = cart.filter(item => item.id !== productId);
                }
                renderCart();
            }
            if (target.classList.contains('remove-from-cart-btn')) {
                cart = cart.filter(item => item.id !== productId);
                renderCart();
            }
        });

        document.getElementById('product-list-manajemen').addEventListener('click', e => {
             const target = e.target.closest('button');
             if (!target) return;
             const id = target.dataset.id;
             if (target.classList.contains('edit-btn')) {
                const product = products.find(p => p.id === id);
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('purchase-price').value = product.purchasePrice;
                document.getElementById('selling-price').value = product.sellingPrice;
                document.getElementById('product-modal-title').textContent = 'Edit Produk';
                productModal.show();
             }
             if (target.classList.contains('delete-btn')) {
                if (confirm('Anda yakin ingin menghapus produk ini?')) {
                    products = products.filter(p => p.id !== id);
                    saveData();
                    renderAll();
                }
             }
        });

        document.querySelector('#view-laporan').addEventListener('click', e => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                renderTransactions();
            }
            if (e.target.closest('.view-detail-btn')) {
                showReceiptModal(e.target.closest('.view-detail-btn').dataset.id);
            }
        });

        document.getElementById('receipt-content-wrapper').addEventListener('click', e => {
            const txId = e.target.dataset.id;
            if (e.target.id === 'add-payment-btn') {
                const amount = parseFloat(document.getElementById('add-payment-amount').value) || 0;
                const kasTujuan = document.getElementById('add-payment-kas').value;
                const tx = transactions.find(t => t.id === txId);
                if (tx && amount > 0) {
                    tx.amountPaid += amount;
                    tx.remainingBalance -= amount;
                    tx.paymentHistory.push({date: new Date().toISOString(), amount: amount, kas: kasTujuan});
                    if (tx.remainingBalance <= 0) {
                        tx.paymentStatus = 'Lunas';
                        tx.remainingBalance = 0;
                    } else {
                        tx.paymentStatus = 'Belum Lunas';
                    }
                    kas[kasTujuan] += amount;
                    saveData();
                    renderAll();
                    showReceiptModal(txId);
                }
            }
            if (e.target.id === 'mark-lunas-btn') {
                 const tx = transactions.find(t => t.id === txId);
                 if (tx) {
                     tx.paymentStatus = 'Lunas';
                     tx.amountPaid = tx.totalAmount;
                     tx.remainingBalance = 0;
                     saveData();
                     renderAll();
                     receiptModal.hide();
                 }
            }
        });

        document.getElementById('share-whatsapp-btn').addEventListener('click', e => {
            const tx = transactions.find(t => t.id === e.target.dataset.id);
            if(!tx) return;
            const receiptText = generateReceiptText(tx, true);
            window.open('https://api.whatsapp.com/send?text=' + encodeURIComponent(receiptText), '_blank');
        });
        
        document.getElementById('ubah-saldo-btn').addEventListener('click', () => {
            document.getElementById('kas-tunai-input').value = kas.Tunai;
            document.getElementById('kas-bank-input').value = kas.Bank;
            document.getElementById('kas-ewallet-input').value = kas['E-Wallet'];
            kasModal.show();
        });

        document.getElementById('kas-form').addEventListener('submit', (e) => {
            e.preventDefault();
            kas.Tunai = parseFloat(document.getElementById('kas-tunai-input').value) || 0;
            kas.Bank = parseFloat(document.getElementById('kas-bank-input').value) || 0;
            kas['E-Wallet'] = parseFloat(document.getElementById('kas-ewallet-input').value) || 0;
            saveData();
            renderKas();
            kasModal.hide();
        });


        // --- INISIALISASI ---
        loadData();
        renderAll();
    });
    </script>
</body>
</html>